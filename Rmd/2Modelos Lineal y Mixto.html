<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.165">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Andrés Gutiérrez - Stalyn Guerrero">

<title>Modelos lineales y mixtos en R y STAN</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="2Modelos Lineal y Mixto_files/libs/clipboard/clipboard.min.js"></script>
<script src="2Modelos Lineal y Mixto_files/libs/quarto-html/quarto.js"></script>
<script src="2Modelos Lineal y Mixto_files/libs/quarto-html/popper.min.js"></script>
<script src="2Modelos Lineal y Mixto_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="2Modelos Lineal y Mixto_files/libs/quarto-html/anchor.min.js"></script>
<link href="2Modelos Lineal y Mixto_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="2Modelos Lineal y Mixto_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="2Modelos Lineal y Mixto_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="2Modelos Lineal y Mixto_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="2Modelos Lineal y Mixto_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Modelos lineales y mixtos en R y STAN</h1>
<p class="subtitle lead">CEPAL - División de Estadísticas Sociales</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Andrés Gutiérrez - Stalyn Guerrero </p>
          </div>
  </div>
    
    
  </div>
  

</header>

<section id="modelos-lineales." class="level2">
<h2 class="anchored" data-anchor-id="modelos-lineales.">Modelos lineales.</h2>
<p>La regresión lineal es la técnica básica del análisis econométrico. Mediante dicha técnica tratamos de determinar relaciones de dependencia de tipo lineal entre una variable dependiente o endógena, respecto de una o varias variables explicativas o exógenas.</p>
<p><span class="math display">\[
\begin{eqnarray*}
\left[\begin{array}{c}
Y_{1}\\
Y_{2}\\
\vdots\\
Y_{n}
\end{array}\right] &amp; = &amp; \left[\begin{array}{cccc}
1 &amp; x_{11} &amp; \cdots &amp; x_{1k}\\
1 &amp; x_{21} &amp; \cdots &amp; x_{2k}\\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots\\
1 &amp; x_{n1} &amp; \cdots &amp; x_{nk}
\end{array}\right]\left[\begin{array}{c}
\beta_{0}\\
\beta_{1}\\
\vdots\\
\beta_{k}
\end{array}\right]+\left[\begin{array}{c}
\epsilon_{1}\\
\epsilon_{2}\\
\vdots\\
\epsilon_{n}
\end{array}\right]
\end{eqnarray*}
\]</span> escrita de forma general sería</p>
<p><span class="math display">\[
\begin{align*}
\boldsymbol{Y} &amp; = &amp; \boldsymbol{X\beta} + \boldsymbol{\epsilon} \\
E\left(\boldsymbol{Y}\mid \boldsymbol{X}\right) &amp; = &amp; \boldsymbol{XB}
\end{align*}
\]</span></p>
<p>donde <span class="math inline">\(\boldsymbol{\epsilon} \sim N\left( 0, \sigma^2\boldsymbol{I}_n\right)\)</span> y el estimador de <span class="math inline">\(B\)</span> esta dado por:</p>
<p><span class="math display">\[
\boldsymbol{\hat{B}}=\boldsymbol{\left(X^{T}X\right)^{-1}X^{T}Y}
\]</span></p>
</section>
<section id="modelos-lineales-bayesiano." class="level2">
<h2 class="anchored" data-anchor-id="modelos-lineales-bayesiano.">Modelos lineales bayesiano.</h2>
<p>En primer lugar, nótese que el interés particular recae en la distribución del vector de <span class="math inline">\(n\)</span> variables aleatorias <span class="math inline">\(\mathbf{Y}=(Y_1\ldots,Y_n)'\)</span> condicional a la matriz de variables auxiliares <span class="math inline">\(\mathbf{X}\)</span> e indexada por el vector de parámetros de interés <span class="math inline">\(\boldsymbol{\beta}=(\beta_0,\ldots,\beta_k)'\)</span> dada por <span class="math inline">\(p(\mathbf{Y} \mid \boldsymbol{\beta},\mathbf{X})\)</span>.</p>
<p>El modelo básico y clásico asume que la verosimilitud para las variables de interés es</p>
<p><span class="math display">\[
\begin{equation*}
\mathbf{Y} \mid \boldsymbol{\beta},\sigma^2,\mathbf{X}\sim N_n(\mathbf{X}\boldsymbol{\beta},\sigma^2\mathbf{I}_n)
\end{equation*}
\]</span></p>
<p>en donde <span class="math inline">\(\mathbf{I}_n\)</span> denota la matriz identidad de orden <span class="math inline">\(n\times n\)</span>. Por supuesto, el modelo normal no es el único que se puede postular como verosimilitud para los datos.</p>
<section id="parámetros-dependientes." class="level3">
<h3 class="anchored" data-anchor-id="parámetros-dependientes.">Parámetros dependientes.</h3>
<p>Los parámetros de interés son <span class="math inline">\(\boldsymbol{\beta}\)</span> y <span class="math inline">\(\sigma^2\)</span> y su distribuciones previa conjunta se supone que está dada por</p>
<p><span class="math display">\[
\begin{equation*}
p(\boldsymbol{\beta},\sigma^2)=p(\boldsymbol{\beta} \mid \sigma^2)p(\sigma^2)
\end{equation*}
\]</span></p>
<p>Específicamente, la distribución previa del parámetro <span class="math inline">\(\boldsymbol{\beta}\)</span> condicionada a <span class="math inline">\(\sigma^2\)</span> es informativa y está regida por la siguiente estructura probabilística</p>
<p><span class="math display">\[
\begin{equation*}
\boldsymbol{\beta} \mid \sigma^2 \sim N_q(\mathbf{b},\sigma^2\mathbf{B})
\end{equation*}
\]</span></p>
<p>en donde <span class="math inline">\(\mathbf{b}\)</span> es un vector de medias y <span class="math inline">\(\mathbf{B}\)</span> es una matriz de varianzas simétrica y definida positiva. Por otro lado, la distribución previa del parámetro <span class="math inline">\(\sigma^2\)</span> también se considera informativa y dada por <span class="math display">\[
\begin{equation*}
\sigma^2 \sim Inversa-Gamma\left( \frac{n_0}{2}, \frac{n_0\sigma^2_0}{2} \right)
\end{equation*}
\]</span></p>
<p>La distribución posterior conjunta de los parámetros de interés <span class="math inline">\(\boldsymbol{\beta},\sigma^2\)</span> está dada por</p>
<p><span class="math display">\[
\begin{align}
p(\boldsymbol{\beta},\sigma^2 \mid \mathbf{Y},\mathbf{X})
&amp;=(\sigma^2)^{-q/2}
\exp\left\{-\frac{1}{2\sigma^2}(\boldsymbol{\beta}-\mathbf{b}_q)'\mathbf{B}_q^{-1}(\boldsymbol{\beta}-\mathbf{b}_q)\right\}
\notag
\\ &amp;\hspace{3cm} \times
(\sigma^2)^{-n_1/2-1}
\exp\left\{-\frac{n_1\sigma^2_1}{2\sigma^2}\right\}
\end{align}
\]</span> donde</p>
<p><span class="math display">\[
\begin{align*}
\mathbf{B}_q &amp;= \left(\mathbf{B}^{-1}+\mathbf{X}'\mathbf{X}\right)^{-1}\\
\mathbf{b}_q &amp;=\mathbf{B}_q\left(\mathbf{B}^{-1}\mathbf{b}+\mathbf{X}'\mathbf{Y}\right)
\end{align*}
\]</span></p>
<p>y además</p>
<p><span class="math display">\[
\begin{align*}
n_1&amp;=n_0+n\\
n_1\sigma^2_1&amp;=
n_0\sigma^2_0+(\mathbf{Y}-\mathbf{X}\mathbf{b}_q)'\mathbf{Y}+(\mathbf{b}-\mathbf{b}_q)'\mathbf{B}^{-1}\mathbf{b}
\end{align*}
\]</span></p>
<p>donde <span class="math inline">\(n_0\)</span> denota el número de datos previos. La distribución posterior conjunta de los parámetros de interés tiene la forma de la distribución Normal-Gamma.</p>
<p>La distribución posterior del vector de parámetros <span class="math inline">\(\boldsymbol{\beta}\)</span> condicionada a <span class="math inline">\(\sigma^2,\mathbf{Y},\mathbf{X}\)</span> es</p>
<p><span class="math display">\[
\begin{equation*}
\boldsymbol{\beta} \mid \sigma^2,\mathbf{Y},\mathbf{X} \sim N_q(\mathbf{b}_q,\sigma^2\mathbf{B}_q)
\end{equation*}
\]</span></p>
<p>La distribución posterior del parámetro <span class="math inline">\(\sigma^2\)</span> condicionada es</p>
<p><span class="math display">\[
\begin{equation*}
\sigma^2 \mid \mathbf{Y},\mathbf{X} \sim Inversa-Gamma\left(\frac{n_1}{2},\frac{\sigma^2_1}{2}\right)
\end{equation*}
\]</span></p>
</section>
<section id="parámetros-independientes" class="level3">
<h3 class="anchored" data-anchor-id="parámetros-independientes">Parámetros independientes</h3>
<p>En esta ocasión se considera que los parámetros son independientes previa; es decir que la distribución previa conjunta está dada por</p>
<p><span class="math display">\[
\begin{equation*}
p(\boldsymbol{\beta},\sigma^2)=p(\boldsymbol{\beta})p(\sigma^2)
\end{equation*}
\]</span></p>
<p>Como es natural, la distribución previa del vector de parámetros <span class="math inline">\(\boldsymbol{\beta}\)</span> es normal, aunque esta vez la matriz de varianzas no va a depender del otro parámetro <span class="math inline">\(\sigma^2\)</span>, por lo tanto se tiene que</p>
<p><span class="math display">\[
\begin{equation*}
\boldsymbol{\beta} \sim N_q(\mathbf{b},\mathbf{B})
\end{equation*}
\]</span></p>
<p>Igualmente, el parámetro <span class="math inline">\(\sigma^2\)</span> no depende de <span class="math inline">\(\boldsymbol{\beta}\)</span> y es posible asignarle la siguiente distribución previa</p>
<p><span class="math display">\[
\begin{equation*}
\sigma^2\sim Inversa-Gamma\left(\frac{n_0}{2},\frac{n_0\sigma^2_0}{2}\right)
\end{equation*}
\]</span></p>
<p>la distribución posterior conjunta de <span class="math inline">\(\boldsymbol{\beta}\)</span> y <span class="math inline">\(\sigma^2\)</span> puede ser escrita como</p>
<p><span class="math display">\[
\begin{align}
p(\boldsymbol{\beta},\sigma^2 \mid \mathbf{Y},\mathbf{X})&amp;\propto p(\mathbf{Y} \mid \boldsymbol{\beta},\sigma^2)p(\boldsymbol{\beta})p(\sigma^2)\notag \\
&amp;\propto (\sigma^2)^{-n/2} \exp\left\{-\frac{1}{2\sigma^2}\left(Q(\boldsymbol{\beta})+S^2_e\right)\right\}\notag\\
&amp;\times
\exp\left\{-\frac{1}{2}(\boldsymbol{\beta}-\mathbf{b})'\mathbf{B}^{-1}(\boldsymbol{\beta}-\mathbf{b})\right\}
(\sigma^2)^{-n_0/2-1} \exp\left\{-\frac{n_0\sigma^2_0}{2\sigma^2}\right\}\notag\\
&amp;=(\sigma^2)^{-\frac{n+n_0}{2}-1}
\exp\left\{-\frac{1}{2\sigma^2}\left[Q(\boldsymbol{\beta})+S^2_e+n_0\sigma^2_0\right]\right\} \notag \\
&amp;\times
\exp\left\{-\frac{1}{2}(\boldsymbol{\beta}-\mathbf{b})'\mathbf{B}^{-1}(\boldsymbol{\beta}-\mathbf{b})\right\}
\end{align}
\]</span></p>
<p>La distribución posterior del parámetro <span class="math inline">\(\boldsymbol{\beta}\)</span> condicionado a <span class="math inline">\(\sigma^2,\mathbf{Y},\mathbf{X}\)</span> es</p>
<p><span class="math display">\[
\begin{equation*}
\boldsymbol{\beta} \mid \sigma^2,\mathbf{Y},\mathbf{X} \sim N_q(\mathbf{b}_q,\mathbf{B}_q)
\end{equation*}
\]</span></p>
<p>donde</p>
<p><span class="math display">\[
\begin{align*}
\mathbf{B}_q &amp;= \left(\mathbf{B}^{-1}+\frac{1}{\sigma^2}\mathbf{X}'\mathbf{X}\right)^{-1}\\
\mathbf{b}_q &amp;=\mathbf{B}_q\left(\mathbf{B}^{-1}\mathbf{b}+\frac{1}{\sigma^2}\mathbf{X}'\mathbf{Y}\right)
\end{align*}
\]</span></p>
<p>La distribución posterior del parámetro <span class="math inline">\(\sigma^2\)</span> condicionado a <span class="math inline">\(\boldsymbol{\beta},\mathbf{Y},\mathbf{X}\)</span> es</p>
<p><span class="math display">\[
\begin{equation*}
\sigma^2 \mid \boldsymbol{\beta},\mathbf{Y},\mathbf{X} \sim Inversa-Gamma\left( \frac{n_1}{2}, \frac{n_1\sigma_{\boldsymbol{\beta}}^2}{2}  \right)
\end{equation*}
\]</span></p>
<p>donde <span class="math inline">\(n_1=n+n_0\)</span>,<br>
<span class="math display">\[
\begin{align*}
n_1\sigma_{\boldsymbol{\beta}}^2&amp;=&amp;Q(\boldsymbol{\beta})+S^2_e+n_0\sigma^2_0\\
Q(\boldsymbol{\beta})&amp;=&amp;(\boldsymbol{\beta}-\hat{\boldsymbol{\beta}})'(\mathbf{X}'\mathbf{X})(\boldsymbol{\beta}-\hat{\boldsymbol{\beta}})\\
S^2_e&amp;=&amp;(\mathbf{y}-\mathbf{X}\hat{\boldsymbol{\beta}})'(\mathbf{y}-\mathbf{X}\hat{\boldsymbol{\beta}})
\end{align*}
\]</span></p>
<p>y <span class="math inline">\(\sigma^2_0\)</span> es una estimación previa del parámetro de interés <span class="math inline">\(\sigma^2\)</span>.</p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-1_04054bdacf8a8aa7e3e598eec15ab7be">

</div>
</section>
<section id="práctica-en-stan-modelo-lineal-simple" class="level3">
<h3 class="anchored" data-anchor-id="práctica-en-stan-modelo-lineal-simple">Práctica en <strong>STAN</strong> (Modelo lineal simple)</h3>
<ul>
<li>ENCUESTA CONTINUA DE HOGARES (ECH) 2020</li>
</ul>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-2_f6f6a61230fb0bee783132b1f15f9aad">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>encuesta <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../Data/encuestaURY20N.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(edad <span class="sc">&gt;</span> <span class="dv">18</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>tasa_desocupacion <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../Data/tasa_desocupacion2.rds"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>(datalm <span class="ot">&lt;-</span> encuesta <span class="sc">%&gt;%</span> </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">depto =</span> <span class="fu">str_pad</span>(</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">string =</span> dpto,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">pad =</span> <span class="st">"0"</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">width =</span> <span class="dv">2</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  ingcorte) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(depto) <span class="sc">%&gt;%</span> </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(  <span class="at">Promedio =</span> <span class="fu">mean</span>(ingcorte)) <span class="sc">%&gt;%</span> </span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(tasa_desocupacion, <span class="at">by =</span> <span class="st">"depto"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 8%">
<col style="width: 12%">
<col style="width: 24%">
<col style="width: 20%">
<col style="width: 18%">
<col style="width: 17%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">depto</th>
<th style="text-align: right;">Promedio</th>
<th style="text-align: right;">tasa_desocupacion</th>
<th style="text-align: right;">Luces_nocturna</th>
<th style="text-align: right;">Suelo_cultivo</th>
<th style="text-align: right;">Suelo_urbano</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">01</td>
<td style="text-align: right;">41200.06</td>
<td style="text-align: right;">0.0666792</td>
<td style="text-align: right;">29595.102</td>
<td style="text-align: right;">6008.267</td>
<td style="text-align: right;">27716.573</td>
</tr>
<tr class="even">
<td style="text-align: left;">02</td>
<td style="text-align: right;">20178.12</td>
<td style="text-align: right;">0.0615587</td>
<td style="text-align: right;">5042.455</td>
<td style="text-align: right;">96538.694</td>
<td style="text-align: right;">2789.773</td>
</tr>
<tr class="odd">
<td style="text-align: left;">03</td>
<td style="text-align: right;">28451.03</td>
<td style="text-align: right;">0.0696271</td>
<td style="text-align: right;">61932.553</td>
<td style="text-align: right;">191183.137</td>
<td style="text-align: right;">24827.843</td>
</tr>
<tr class="even">
<td style="text-align: left;">04</td>
<td style="text-align: right;">20273.52</td>
<td style="text-align: right;">0.0647848</td>
<td style="text-align: right;">6373.506</td>
<td style="text-align: right;">282859.039</td>
<td style="text-align: right;">4045.102</td>
</tr>
<tr class="odd">
<td style="text-align: left;">05</td>
<td style="text-align: right;">26353.41</td>
<td style="text-align: right;">0.0418771</td>
<td style="text-align: right;">17658.996</td>
<td style="text-align: right;">413940.753</td>
<td style="text-align: right;">7373.220</td>
</tr>
<tr class="even">
<td style="text-align: left;">06</td>
<td style="text-align: right;">26101.20</td>
<td style="text-align: right;">0.0565903</td>
<td style="text-align: right;">8937.016</td>
<td style="text-align: right;">260584.235</td>
<td style="text-align: right;">3485.773</td>
</tr>
<tr class="odd">
<td style="text-align: left;">07</td>
<td style="text-align: right;">29259.10</td>
<td style="text-align: right;">0.0449447</td>
<td style="text-align: right;">3105.961</td>
<td style="text-align: right;">202118.604</td>
<td style="text-align: right;">2070.012</td>
</tr>
<tr class="even">
<td style="text-align: left;">08</td>
<td style="text-align: right;">28382.54</td>
<td style="text-align: right;">0.0563808</td>
<td style="text-align: right;">9133.392</td>
<td style="text-align: right;">427540.894</td>
<td style="text-align: right;">4271.471</td>
</tr>
<tr class="odd">
<td style="text-align: left;">09</td>
<td style="text-align: right;">26428.93</td>
<td style="text-align: right;">0.0570070</td>
<td style="text-align: right;">6858.906</td>
<td style="text-align: right;">268888.988</td>
<td style="text-align: right;">4218.702</td>
</tr>
<tr class="even">
<td style="text-align: left;">10</td>
<td style="text-align: right;">28970.37</td>
<td style="text-align: right;">0.0508015</td>
<td style="text-align: right;">20933.169</td>
<td style="text-align: right;">91208.478</td>
<td style="text-align: right;">9864.745</td>
</tr>
<tr class="odd">
<td style="text-align: left;">11</td>
<td style="text-align: right;">25903.19</td>
<td style="text-align: right;">0.0588967</td>
<td style="text-align: right;">11204.749</td>
<td style="text-align: right;">354537.710</td>
<td style="text-align: right;">5420.133</td>
</tr>
<tr class="even">
<td style="text-align: left;">12</td>
<td style="text-align: right;">23778.48</td>
<td style="text-align: right;">0.0755263</td>
<td style="text-align: right;">6993.475</td>
<td style="text-align: right;">384763.745</td>
<td style="text-align: right;">3115.224</td>
</tr>
<tr class="odd">
<td style="text-align: left;">13</td>
<td style="text-align: right;">19828.38</td>
<td style="text-align: right;">0.0601342</td>
<td style="text-align: right;">7307.502</td>
<td style="text-align: right;">86058.847</td>
<td style="text-align: right;">3040.980</td>
</tr>
<tr class="even">
<td style="text-align: left;">14</td>
<td style="text-align: right;">24960.09</td>
<td style="text-align: right;">0.0564731</td>
<td style="text-align: right;">10670.400</td>
<td style="text-align: right;">281370.863</td>
<td style="text-align: right;">4818.361</td>
</tr>
<tr class="odd">
<td style="text-align: left;">15</td>
<td style="text-align: right;">23782.52</td>
<td style="text-align: right;">0.0634757</td>
<td style="text-align: right;">9416.886</td>
<td style="text-align: right;">165983.910</td>
<td style="text-align: right;">4762.259</td>
</tr>
<tr class="even">
<td style="text-align: left;">16</td>
<td style="text-align: right;">24429.02</td>
<td style="text-align: right;">0.0619945</td>
<td style="text-align: right;">22229.902</td>
<td style="text-align: right;">291555.851</td>
<td style="text-align: right;">5303.322</td>
</tr>
<tr class="odd">
<td style="text-align: left;">17</td>
<td style="text-align: right;">25172.54</td>
<td style="text-align: right;">0.0564711</td>
<td style="text-align: right;">9021.925</td>
<td style="text-align: right;">566605.298</td>
<td style="text-align: right;">3977.627</td>
</tr>
<tr class="even">
<td style="text-align: left;">18</td>
<td style="text-align: right;">20496.49</td>
<td style="text-align: right;">0.0649554</td>
<td style="text-align: right;">6809.667</td>
<td style="text-align: right;">180824.812</td>
<td style="text-align: right;">3902.745</td>
</tr>
<tr class="odd">
<td style="text-align: left;">19</td>
<td style="text-align: right;">22647.60</td>
<td style="text-align: right;">0.0695013</td>
<td style="text-align: right;">5830.145</td>
<td style="text-align: right;">268517.027</td>
<td style="text-align: right;">3459.565</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Diagrama de dispersión por las variables</p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-3_b579a5803e7b87460c8c58a77ee29e8b">
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Creando código de <code>STAN</code></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-4_fc5114a1d7496fcffb3a9509715b6403">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>data {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> n;   <span class="sc">/</span><span class="er">/</span> Número de observaciones</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  vector[n] x;      <span class="sc">/</span><span class="er">/</span> Variable predictora</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  vector[n] y;      <span class="sc">/</span><span class="er">/</span> Variable respuesta</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>parameters {</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  real b0;            <span class="sc">/</span><span class="er">/</span> Intercepto</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  real b1;            <span class="sc">/</span><span class="er">/</span> Pendiente</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  real<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> sigma2;  </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>transformed parameters{</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  real<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> sigma;</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  sigma <span class="ot">=</span> <span class="fu">sqrt</span>(sigma2);</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>model {</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  b0 <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1000</span>);</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  b1 <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1000</span>);</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  sigma2 <span class="sc">~</span> <span class="fu">inv_gamma</span>(<span class="fl">0.0001</span>, <span class="fl">0.0001</span>);</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="fu">normal</span>(b0 <span class="sc">+</span> b1<span class="sc">*</span>x, sigma);  <span class="sc">/</span><span class="er">/</span> likelihood</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>generated quantities {</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    real ypred[n];                    <span class="sc">/</span><span class="er">/</span> vector de longitud n</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    ypred <span class="ot">=</span> <span class="fu">normal_rng</span>(b0 <span class="sc">+</span> b1<span class="sc">*</span>x, sigma);</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Preparando el código de <code>STAN</code></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-5_3147e712f216af2791e1da3b54346e7b">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Definir el modelo</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>fitLm1 <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="at">stan_file =</span> <span class="st">"../Data/modelosStan/ModeloLm1.stan"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Organizando datos para <code>STAN</code></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-6_04e420bcc7c1043a26451ad214c7f030">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>sample_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">n =</span> <span class="fu">nrow</span>(datalm),</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">x =</span> datalm<span class="sc">$</span>Suelo_urbano,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">y =</span> datalm<span class="sc">$</span>Promedio)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para ejecutar <code>STAN</code> en R tenemos la librería <em>cmdstanr</em></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-7_eaf0a06a67b59f5e4dd5f6aedf20dbf0">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>model_fitLm1 <span class="ot">&lt;-</span> fitLm1<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> sample_data, </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">parallel_chains =</span> <span class="dv">4</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">num_warmup =</span> <span class="dv">2000</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">num_samples =</span> <span class="dv">1000</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">seed =</span> <span class="dv">1234</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">refresh =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 finished in 0.4 seconds.
Chain 2 finished in 0.4 seconds.
Chain 3 finished in 0.4 seconds.
Chain 4 finished in 0.4 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.4 seconds.
Total execution time: 0.9 seconds.</code></pre>
</div>
</div>
<p>La estimación del parámetro <span class="math inline">\(B\)</span> es:</p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-8_df481389f82bf5918c5973730a9df770">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>model_fitLm1<span class="sc">$</span><span class="fu">summary</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"b0"</span>,<span class="st">"b1"</span>,<span class="st">"sigma"</span>,<span class="st">"sigma2"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(variable, mean,sd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">b0</td>
<td style="text-align: right;">8.239326e+02</td>
<td style="text-align: right;">1.001445e+03</td>
</tr>
<tr class="even">
<td style="text-align: left;">b1</td>
<td style="text-align: right;">2.048245e+00</td>
<td style="text-align: right;">4.041642e-01</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">1.662340e+04</td>
<td style="text-align: right;">3.018359e+03</td>
</tr>
<tr class="even">
<td style="text-align: left;">sigma2</td>
<td style="text-align: right;">2.854455e+08</td>
<td style="text-align: right;">1.090641e+08</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-9_e8295157fd049b179aa2bf0fa851f9bd">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>(<span class="fu">mcmc_hist_by_chain</span>(model_fitLm1<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"b0"</span>)) <span class="sc">+</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(model_fitLm1<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"b0"</span>)))<span class="sc">/</span> </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(model_fitLm1<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"b0"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-10_39dfbf201a7d373aa80182a844964417">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">mcmc_hist_by_chain</span>(model_fitLm1<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"b1"</span>)) <span class="sc">+</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(model_fitLm1<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"b1"</span>)))<span class="sc">/</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(model_fitLm1<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"b1"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-11_336866c96270608d7221af733773b55e">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">mcmc_hist_by_chain</span>(model_fitLm1<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"sigma2"</span>)) <span class="sc">+</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(model_fitLm1<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"sigma2"</span>)))<span class="sc">/</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(model_fitLm1<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"sigma2"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-12_8580c7a6e17cb1b8169d9804fd6d5696">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>y_pred_B <span class="ot">&lt;-</span> model_fitLm1<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="st">"ypred"</span>, <span class="at">format =</span> <span class="st">"matrix"</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>rowsrandom <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(y_pred_B), <span class="dv">100</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>y_pred2 <span class="ot">&lt;-</span> y_pred_B[rowsrandom, ]</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ppc_dens_overlay</span>(<span class="at">y =</span> <span class="fu">as.numeric</span>(datalm<span class="sc">$</span>Promedio), y_pred2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="práctica-en-stan-modelo-lineal-múltiple" class="level3">
<h3 class="anchored" data-anchor-id="práctica-en-stan-modelo-lineal-múltiple">Práctica en <strong>STAN</strong> (modelo lineal múltiple)</h3>
<p>Creando código de <code>STAN</code></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-13_01cd1c53ee2d8ef4296788ba799469fb">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>data {</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> n;   <span class="sc">/</span><span class="er">/</span> Número de observaciones</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> K;   <span class="sc">/</span><span class="er">/</span> Número de predictores</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  matrix[n, K] x;   <span class="sc">/</span><span class="er">/</span> Matrix de predictores</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  vector[n] y;      <span class="sc">/</span><span class="er">/</span> Vector respuesta</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>parameters {</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  vector[K] beta;       <span class="sc">/</span><span class="er">/</span> coefficients <span class="cf">for</span> predictors</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  real<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> sigma2;  <span class="sc">/</span><span class="er">/</span> error scale</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>transformed parameters{</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  real<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> sigma;</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  sigma <span class="ot">=</span> <span class="fu">sqrt</span>(sigma2);</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>model {</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">to_vector</span>(beta) <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">10000</span>);</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  sigma2 <span class="sc">~</span> <span class="fu">inv_gamma</span>(<span class="fl">0.0001</span>, <span class="fl">0.0001</span>);</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="fu">normal</span>(x <span class="sc">*</span> beta, sigma);  <span class="sc">/</span><span class="er">/</span> likelihood</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>generated quantities {</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    real ypred[n];                    <span class="sc">/</span><span class="er">/</span> vector de longitud n</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    ypred <span class="ot">=</span> <span class="fu">normal_rng</span>(x <span class="sc">*</span> beta, sigma);</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Preparando el código de <code>STAN</code></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-14_8f9d13397e47d3af57b0d3e6139aecaf">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>fitLm2 <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="at">stan_file =</span> <span class="st">"../Data/modelosStan/ModeloLm2.stan"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Organizando datos para <code>STAN</code></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-15_d80bf27534ed8de943d2925f97e5a8a6">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>(Xdat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(Promedio <span class="sc">~</span> tasa_desocupacion <span class="sc">+</span> Luces_nocturna <span class="sc">+</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                       Suelo_cultivo <span class="sc">+</span> Suelo_urbano,<span class="at">data =</span> datalm))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 16%">
<col style="width: 25%">
<col style="width: 20%">
<col style="width: 19%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">(Intercept)</th>
<th style="text-align: right;">tasa_desocupacion</th>
<th style="text-align: right;">Luces_nocturna</th>
<th style="text-align: right;">Suelo_cultivo</th>
<th style="text-align: right;">Suelo_urbano</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0666792</td>
<td style="text-align: right;">29595.102</td>
<td style="text-align: right;">6008.267</td>
<td style="text-align: right;">27716.573</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0615587</td>
<td style="text-align: right;">5042.455</td>
<td style="text-align: right;">96538.694</td>
<td style="text-align: right;">2789.773</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0696271</td>
<td style="text-align: right;">61932.553</td>
<td style="text-align: right;">191183.137</td>
<td style="text-align: right;">24827.843</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0647848</td>
<td style="text-align: right;">6373.506</td>
<td style="text-align: right;">282859.039</td>
<td style="text-align: right;">4045.102</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0418771</td>
<td style="text-align: right;">17658.996</td>
<td style="text-align: right;">413940.753</td>
<td style="text-align: right;">7373.220</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0565903</td>
<td style="text-align: right;">8937.016</td>
<td style="text-align: right;">260584.235</td>
<td style="text-align: right;">3485.773</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0449447</td>
<td style="text-align: right;">3105.961</td>
<td style="text-align: right;">202118.604</td>
<td style="text-align: right;">2070.012</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0563808</td>
<td style="text-align: right;">9133.392</td>
<td style="text-align: right;">427540.894</td>
<td style="text-align: right;">4271.471</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0570070</td>
<td style="text-align: right;">6858.906</td>
<td style="text-align: right;">268888.988</td>
<td style="text-align: right;">4218.702</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0508015</td>
<td style="text-align: right;">20933.169</td>
<td style="text-align: right;">91208.478</td>
<td style="text-align: right;">9864.745</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0588967</td>
<td style="text-align: right;">11204.749</td>
<td style="text-align: right;">354537.710</td>
<td style="text-align: right;">5420.133</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0755263</td>
<td style="text-align: right;">6993.475</td>
<td style="text-align: right;">384763.745</td>
<td style="text-align: right;">3115.224</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0601342</td>
<td style="text-align: right;">7307.502</td>
<td style="text-align: right;">86058.847</td>
<td style="text-align: right;">3040.980</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0564731</td>
<td style="text-align: right;">10670.400</td>
<td style="text-align: right;">281370.863</td>
<td style="text-align: right;">4818.361</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0634757</td>
<td style="text-align: right;">9416.886</td>
<td style="text-align: right;">165983.910</td>
<td style="text-align: right;">4762.259</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0619945</td>
<td style="text-align: right;">22229.902</td>
<td style="text-align: right;">291555.851</td>
<td style="text-align: right;">5303.322</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0564711</td>
<td style="text-align: right;">9021.925</td>
<td style="text-align: right;">566605.298</td>
<td style="text-align: right;">3977.627</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0649554</td>
<td style="text-align: right;">6809.667</td>
<td style="text-align: right;">180824.812</td>
<td style="text-align: right;">3902.745</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0695013</td>
<td style="text-align: right;">5830.145</td>
<td style="text-align: right;">268517.027</td>
<td style="text-align: right;">3459.565</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-16_ad27f6f8b699108469383d364e2e152a">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>sample_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">n =</span> <span class="fu">nrow</span>(datalm),</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">K =</span> <span class="fu">ncol</span>(Xdat),</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">x =</span> <span class="fu">as.matrix</span>(Xdat),</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">y =</span> datalm<span class="sc">$</span>Promedio)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para ejecutar <code>STAN</code> en R tenemos la librería <em>cmdstanr</em></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-17_7f3afc31e993fe7257e601c6da65f7a5">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>model_fitLm2 <span class="ot">&lt;-</span> fitLm2<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> sample_data, </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">parallel_chains =</span> <span class="dv">4</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">seed =</span> <span class="dv">1234</span>,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">refresh =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 finished in 1.8 seconds.
Chain 4 finished in 2.6 seconds.
Chain 3 finished in 2.8 seconds.
Chain 2 finished in 3.0 seconds.

All 4 chains finished successfully.
Mean chain execution time: 2.6 seconds.
Total execution time: 3.3 seconds.</code></pre>
</div>
</div>
<p>La estimación del parámetro <span class="math inline">\(B\)</span> es:</p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-18_1e3aaca38e11d80aa21cf3068fc49777">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>model_fitLm2<span class="sc">$</span><span class="fu">summary</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"beta"</span>,<span class="st">"sigma2"</span>))<span class="sc">%&gt;%</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(variable, mean,sd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">beta[1]</td>
<td style="text-align: right;">1.964638e+04</td>
<td style="text-align: right;">2.140133e+03</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[2]</td>
<td style="text-align: right;">-1.110047e+03</td>
<td style="text-align: right;">1.023341e+04</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta[3]</td>
<td style="text-align: right;">-2.771689e-01</td>
<td style="text-align: right;">1.072407e-01</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[4]</td>
<td style="text-align: right;">1.022820e-02</td>
<td style="text-align: right;">6.045200e-03</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta[5]</td>
<td style="text-align: right;">1.050852e+00</td>
<td style="text-align: right;">2.230622e-01</td>
</tr>
<tr class="even">
<td style="text-align: left;">sigma2</td>
<td style="text-align: right;">9.843444e+06</td>
<td style="text-align: right;">4.597092e+06</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-19_c04935f78407c45743d50e134602d54e">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">mcmc_hist_by_chain</span>(model_fitLm2<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"beta[1]"</span>)) <span class="sc">+</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(model_fitLm2<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"beta[1]"</span>)))<span class="sc">/</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(model_fitLm2<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"beta[1]"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-20_07e74eaad6324036726edb218da5151c">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">mcmc_hist_by_chain</span>(model_fitLm2<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"beta[2]"</span>)) <span class="sc">+</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(model_fitLm2<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"beta[2]"</span>)))<span class="sc">/</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(model_fitLm2<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"beta[2]"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-21_cf803d462d641ee29ca88419bac3b3b1">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">mcmc_hist_by_chain</span>(model_fitLm2<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"beta[3]"</span>)) <span class="sc">+</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(model_fitLm2<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"beta[3]"</span>)))<span class="sc">/</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(model_fitLm2<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"beta[3]"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-22_110d1259a7558c6d0595f90453277475">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">mcmc_hist_by_chain</span>(model_fitLm2<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"beta[4]"</span>)) <span class="sc">+</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(model_fitLm2<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"beta[4]"</span>)))<span class="sc">/</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(model_fitLm2<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"beta[4]"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-23_429a1b2ec14bfdada23fa5afa7675b46">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">mcmc_hist_by_chain</span>(model_fitLm1<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"sigma2"</span>)) <span class="sc">+</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(model_fitLm1<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"sigma2"</span>)))<span class="sc">/</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(model_fitLm1<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"sigma2"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-24_ec32e2eb0d8aab2e8d78bc5eb1c7bf63">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>y_pred_B <span class="ot">&lt;-</span> model_fitLm2<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="st">"ypred"</span>, <span class="at">format =</span> <span class="st">"matrix"</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>rowsrandom <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(y_pred_B), <span class="dv">100</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>y_pred2 <span class="ot">&lt;-</span> y_pred_B[rowsrandom,]</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ppc_dens_overlay</span>(<span class="at">y =</span> <span class="fu">as.numeric</span>(datalm<span class="sc">$</span>Promedio), y_pred2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="modelo-lineal-generalizado" class="level1">
<h1>Modelo lineal generalizado</h1>
<section id="modelo-bernoulli-con-vínculo-logístico" class="level2">
<h2 class="anchored" data-anchor-id="modelo-bernoulli-con-vínculo-logístico">Modelo Bernoulli con vínculo logístico</h2>
<p>Este caso es típico en donde la variable respuesta sólo toma dos valores, uno en caso de un evento exitoso y cero, cuando se presenta un fracaso. Se supone que <span class="math inline">\(\mathbf{Y}=\{Y_1, \ldots, Y_n\}\)</span> es un conjunto de variables aleatorias intercambiables cada una con distribución bernoulli de parámetro <span class="math inline">\(\theta_i\)</span>, y se quiere estudiar la relación entre <span class="math inline">\(\theta_i\)</span> y las variables auxiliares <span class="math inline">\(\mathbf{X}_i\)</span> por medio de la función de enlace <span class="math inline">\(g(\theta_i)=\mathbf{X}_i'\boldsymbol{\beta}\)</span>. Aquí consideramos la función de enlace logística</p>
<p><span class="math display">\[
\begin{equation}
\eta_i=g(\theta_i)=logit(\theta_i)=\log\left(\frac{\theta_i}{1-\theta_i}\right)
\end{equation}
\]</span></p>
<p>fácilmente se encuentra que la función inversa para <span class="math inline">\(g(\cdot)\)</span>, está dada por</p>
<p><span class="math display">\[
\begin{equation*}
\theta_i=g^{-1}(\eta_i)=\frac{\exp(\eta_i)}{1+\exp(\eta_i)}
\end{equation*}
\]</span></p>
<p>Notando que <span class="math inline">\(\eta_i=\mathbf{X}_i'\boldsymbol{\beta}\)</span> y siguiendo con el modelamiento, se tiene que la verosimilitud de los datos está dada por</p>
<p><span class="math display">\[
\begin{align}
p(\mathbf{Y}\mid \boldsymbol{\theta})&amp;=\prod_{i=1}^n\theta_i^{y_i}(1-\theta_i)^{1-y_i} \notag \\
p(\mathbf{Y}\mid \boldsymbol{\beta})&amp;=\prod_{i=1}^n\left(\frac{\exp(\mathbf{X}_i'\boldsymbol{\beta})}{1+\exp(\mathbf{X}_i'\boldsymbol{\beta})}\right)^{y_i}
\left(1-\left(\frac{\exp(\mathbf{X}_i'\boldsymbol{\beta})}{1+\exp(\mathbf{X}_i'\boldsymbol{\beta})}\right)\right)^{1-y_i}
\end{align}
\]</span></p>
<p>Suponga que la distribución a previa para <span class="math inline">\(\boldsymbol{\beta}\)</span> está regida por la siguiente estructura probabilística</p>
<p><span class="math display">\[
\begin{equation*}
\boldsymbol{\beta}\sim N_q(\mathbf{b},\mathbf{B})
\end{equation*}
\]</span></p>
<p>De esta manera, la distribución a posterior toma la siguiente forma.</p>
<p><span class="math display">\[
\begin{align*}
p(\boldsymbol{\beta} \mid \mathbf{Y}, \mathbf{X})&amp;\propto
\prod_{i=1}^n\left(\frac{\exp(\mathbf{X}_i'\boldsymbol{\beta})}{1+\exp(\mathbf{X}_i'\boldsymbol{\beta})}\right)^{y_i}
\left(1-\left(\frac{\exp(\mathbf{X}_i'\boldsymbol{\beta})}{1+\exp(\mathbf{X}_i'\boldsymbol{\beta})}\right)\right)^{1-y_i}\\
&amp;\hspace{2cm}\times
\exp\left\{\frac{-1}{2}(\boldsymbol{\beta}-\mathbf{b})'\mathbf{B}^{-1}(\boldsymbol{\beta}-\mathbf{b})\right\}
\end{align*}
\]</span></p>
<p>La anterior expresión no tiene una forma cerrada y no es sencillo, en primera instancia, simular observaciones u obtener inferencias a posterior.</p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-25_6b1202dc56669e598da7522b4b9f2657">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forcats)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>datalogit <span class="ot">&lt;-</span> encuesta <span class="sc">%&gt;%</span> </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">depto =</span> <span class="fu">str_pad</span>(</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">string =</span> dpto,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">pad =</span> <span class="st">"0"</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">width =</span> <span class="dv">2</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">pobreza =</span> <span class="fu">ifelse</span>(ingcorte <span class="sc">&lt;</span> lp, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">sexo =</span> <span class="fu">as_factor</span>(sexo),  </span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">anoest =</span> <span class="fu">case_when</span>(</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    edad <span class="sc">&lt;</span> <span class="dv">5</span> <span class="sc">|</span> <span class="fu">is.na</span>(anoest)   <span class="sc">~</span> <span class="st">"98"</span>  , <span class="co">#No aplica</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    anoest <span class="sc">==</span> <span class="dv">99</span> <span class="sc">~</span> <span class="st">"99"</span>, <span class="co">#NS/NR</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    anoest <span class="sc">==</span> <span class="dv">0</span>  <span class="sc">~</span> <span class="st">"1"</span>, <span class="co"># Sin educacion</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    anoest <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>) <span class="sc">~</span> <span class="st">"2"</span>,       <span class="co"># 1 - 6</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    anoest <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">7</span><span class="sc">:</span><span class="dv">12</span>) <span class="sc">~</span> <span class="st">"3"</span>,      <span class="co"># 7 - 12</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    anoest <span class="sc">&gt;</span> <span class="dv">12</span> <span class="sc">~</span> <span class="st">"4"</span>,      <span class="co"># mas de 12</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Error"</span>  ),</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">edad =</span> <span class="fu">case_when</span>(</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    edad <span class="sc">&lt;</span> <span class="dv">15</span> <span class="sc">~</span> <span class="st">"1"</span>,</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    edad <span class="sc">&lt;</span> <span class="dv">30</span> <span class="sc">~</span> <span class="st">"2"</span>,</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    edad <span class="sc">&lt;</span> <span class="dv">45</span> <span class="sc">~</span> <span class="st">"3"</span>,</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    edad <span class="sc">&lt;</span> <span class="dv">65</span> <span class="sc">~</span> <span class="st">"4"</span>,</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"5"</span>),</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(depto <span class="sc">==</span><span class="st">"04"</span>,</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>           anoest <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>))</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(datalogit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">depto</th>
<th style="text-align: right;">pobreza</th>
<th style="text-align: left;">sexo</th>
<th style="text-align: left;">anoest</th>
<th style="text-align: left;">edad</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">04</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">Hombre</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">4</td>
</tr>
<tr class="even">
<td style="text-align: left;">04</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">Mujer</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">04</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">Mujer</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">04</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">Mujer</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">04</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">Mujer</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">5</td>
</tr>
<tr class="even">
<td style="text-align: left;">04</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">Mujer</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">3</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="práctica-en-stan" class="level3">
<h3 class="anchored" data-anchor-id="práctica-en-stan">Práctica en <strong>STAN</strong></h3>
<p>Creando código de <code>STAN</code></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-26_639cf1058594c31d456f92ef2dfc8b2f">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>data {</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> n;   <span class="sc">/</span><span class="er">/</span> Número de observaciones</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> K;   <span class="sc">/</span><span class="er">/</span> Número de predictores</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  matrix[n, K] x;   <span class="sc">/</span><span class="er">/</span> Matrix de predictores</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  int y;      <span class="sc">/</span><span class="er">/</span> Vector respuesta</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>parameters {</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  vector[K] beta;       <span class="sc">/</span><span class="er">/</span> coefficients <span class="cf">for</span> predictors</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>transformed parameters {</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    vector[n] inv_eta;</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>   inv_eta <span class="ot">=</span> <span class="fu">inv_logit</span>(x <span class="sc">*</span> beta);</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>model {</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">to_vector</span>(beta) <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">10000</span>);</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="fu">bernoulli</span>(inv_eta);  <span class="sc">/</span><span class="er">/</span> likelihood</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>generated quantities {</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    real ypred[n];                    <span class="sc">/</span><span class="er">/</span> vector de longitud n</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    ypred <span class="ot">=</span> <span class="fu">bernoulli_rng</span>(inv_eta);</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Preparando el código de <code>STAN</code></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-27_2c965074ec091b193a96f08c3df4e724">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>fitLosgit1 <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="at">stan_file =</span> <span class="st">"../Data/modelosStan/ModeloLogit.stan"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Organizando datos para <code>STAN</code></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-28_cd29169bb5bcf338e55df13d50772284">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>Xdat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(pobreza <span class="sc">~</span> sexo <span class="sc">+</span> anoest <span class="sc">+</span> edad,</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> datalogit)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Xdat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 18%">
<col style="width: 15%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">(Intercept)</th>
<th style="text-align: right;">sexoMujer</th>
<th style="text-align: right;">anoest2</th>
<th style="text-align: right;">anoest3</th>
<th style="text-align: right;">anoest4</th>
<th style="text-align: right;">edad3</th>
<th style="text-align: right;">edad4</th>
<th style="text-align: right;">edad5</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-29_e901608fe40fe63aecd183bde55ac993">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>sample_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">n =</span> <span class="fu">nrow</span>(datalogit),</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">K =</span> <span class="fu">ncol</span>(Xdat),</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">x =</span> <span class="fu">as.matrix</span>(Xdat),</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">y =</span> datalogit<span class="sc">$</span>pobreza)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para ejecutar <code>STAN</code> en R tenemos la librería <em>cmdstanr</em></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-30_f0c640f4a495e85e2426706be00d57d4">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>model_Losgit1 <span class="ot">&lt;-</span> fitLosgit1<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> sample_data, </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">parallel_chains =</span> <span class="dv">4</span>,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">seed =</span> <span class="dv">1234</span>,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">refresh =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 finished in 47.0 seconds.
Chain 4 finished in 49.7 seconds.
Chain 2 finished in 50.5 seconds.
Chain 3 finished in 51.0 seconds.

All 4 chains finished successfully.
Mean chain execution time: 49.6 seconds.
Total execution time: 51.3 seconds.</code></pre>
</div>
</div>
<p>La estimación del parámetro <span class="math inline">\(B\)</span> es:</p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-31_90d6248cfab7073834ee1845ddcd1903">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>model_Losgit1<span class="sc">$</span><span class="fu">summary</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"beta"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 8%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">mad</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
<th style="text-align: right;">rhat</th>
<th style="text-align: right;">ess_bulk</th>
<th style="text-align: right;">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">beta[1]</td>
<td style="text-align: right;">-3.3497376</td>
<td style="text-align: right;">-3.2273700</td>
<td style="text-align: right;">0.8457605</td>
<td style="text-align: right;">0.7557035</td>
<td style="text-align: right;">-4.8905335</td>
<td style="text-align: right;">-2.1668655</td>
<td style="text-align: right;">1.0022890</td>
<td style="text-align: right;">640.9310</td>
<td style="text-align: right;">508.5378</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[2]</td>
<td style="text-align: right;">0.1018459</td>
<td style="text-align: right;">0.1057320</td>
<td style="text-align: right;">0.1822503</td>
<td style="text-align: right;">0.1807269</td>
<td style="text-align: right;">-0.1942952</td>
<td style="text-align: right;">0.4030622</td>
<td style="text-align: right;">0.9999778</td>
<td style="text-align: right;">3179.5454</td>
<td style="text-align: right;">2367.4879</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta[3]</td>
<td style="text-align: right;">1.9818516</td>
<td style="text-align: right;">1.8647400</td>
<td style="text-align: right;">0.8424081</td>
<td style="text-align: right;">0.7763413</td>
<td style="text-align: right;">0.8179544</td>
<td style="text-align: right;">3.5258710</td>
<td style="text-align: right;">1.0018374</td>
<td style="text-align: right;">612.5555</td>
<td style="text-align: right;">600.8927</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[4]</td>
<td style="text-align: right;">1.1282628</td>
<td style="text-align: right;">1.0155750</td>
<td style="text-align: right;">0.8412230</td>
<td style="text-align: right;">0.7613448</td>
<td style="text-align: right;">-0.0242025</td>
<td style="text-align: right;">2.6951585</td>
<td style="text-align: right;">1.0019149</td>
<td style="text-align: right;">623.2609</td>
<td style="text-align: right;">637.3172</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta[5]</td>
<td style="text-align: right;">-1.0411763</td>
<td style="text-align: right;">-1.0901700</td>
<td style="text-align: right;">1.0325339</td>
<td style="text-align: right;">0.9894984</td>
<td style="text-align: right;">-2.6619860</td>
<td style="text-align: right;">0.7483496</td>
<td style="text-align: right;">1.0027252</td>
<td style="text-align: right;">692.8100</td>
<td style="text-align: right;">848.8655</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[6]</td>
<td style="text-align: right;">-0.2486105</td>
<td style="text-align: right;">-0.2432475</td>
<td style="text-align: right;">0.2242935</td>
<td style="text-align: right;">0.2208706</td>
<td style="text-align: right;">-0.6210340</td>
<td style="text-align: right;">0.1179966</td>
<td style="text-align: right;">1.0010698</td>
<td style="text-align: right;">1840.8184</td>
<td style="text-align: right;">2249.4020</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta[7]</td>
<td style="text-align: right;">-1.6602107</td>
<td style="text-align: right;">-1.6597800</td>
<td style="text-align: right;">0.2628274</td>
<td style="text-align: right;">0.2648887</td>
<td style="text-align: right;">-2.0887085</td>
<td style="text-align: right;">-1.2284460</td>
<td style="text-align: right;">1.0008309</td>
<td style="text-align: right;">2012.8296</td>
<td style="text-align: right;">2437.3561</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[8]</td>
<td style="text-align: right;">-4.0842036</td>
<td style="text-align: right;">-4.0112500</td>
<td style="text-align: right;">0.6726816</td>
<td style="text-align: right;">0.6339301</td>
<td style="text-align: right;">-5.3120995</td>
<td style="text-align: right;">-3.1193270</td>
<td style="text-align: right;">1.0015888</td>
<td style="text-align: right;">2563.4578</td>
<td style="text-align: right;">2009.1281</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-32_585dcab31a1e6ded47f1184ce54d1115">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(model_Losgit1<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"beta"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-33_303c563010809ef6c98a0abbb31caa28">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(model_Losgit1<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"beta"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-34_2ac194bed6c8dd4b964c7bbf863be531">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>y_pred_B <span class="ot">&lt;-</span> model_Losgit1<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="st">"ypred"</span>, <span class="at">format =</span> <span class="st">"matrix"</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>rowsrandom <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(y_pred_B), <span class="dv">100</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>y_pred2 <span class="ot">&lt;-</span> y_pred_B[rowsrandom, ]</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ppc_dens_overlay</span>(<span class="at">y =</span> <span class="fu">as.numeric</span>(datalogit<span class="sc">$</span>pobreza), y_pred2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Una alternativa es hacer el siguiente modelo que utiliza la función <code>bernoulli_logit</code></p>
<p>Creando código de <code>STAN</code></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-35_4ad4e9e73bd8697882b6f2d0f792e41c">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>data {</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> n;   <span class="sc">/</span><span class="er">/</span> Número de observaciones</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> K;   <span class="sc">/</span><span class="er">/</span> Número de predictores</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  matrix[n, K] x;   <span class="sc">/</span><span class="er">/</span> Matrix de predictores</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span>,upper<span class="ot">=</span><span class="dv">1</span><span class="sc">&gt;</span> y[n];       <span class="sc">/</span><span class="er">/</span> Vector respuesta</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>parameters {</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  vector[K] beta;       <span class="sc">/</span><span class="er">/</span> coefficients <span class="cf">for</span> predictors</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>transformed parameters {</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>   vector[n] eta;</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>   eta <span class="ot">=</span> x <span class="sc">*</span> beta;</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>model {</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">to_vector</span>(beta) <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">10000</span>);</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="fu">bernoulli_logit</span>(eta);  <span class="sc">/</span><span class="er">/</span> likelihood</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>generated quantities {</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>    real ypred[n];                    <span class="sc">/</span><span class="er">/</span> vector de longitud n</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    ypred <span class="ot">=</span> <span class="fu">bernoulli_logit_rng</span>(eta);</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Preparando el código de <code>STAN</code></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-36_1708b7e3e58d9ecb678a53d5675450f8">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>fitLosgit2 <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="at">stan_file =</span> <span class="st">"../Data/modelosStan/ModeloLogit2.stan"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para ejecutar <code>STAN</code> en R tenemos la librería <em>cmdstanr</em></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-37_42dd30dff98a989532286058bfa7bdf8">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>model_Losgit2 <span class="ot">&lt;-</span> fitLosgit2<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> sample_data, </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">num_warmup =</span> <span class="dv">10000</span>,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">num_samples =</span> <span class="dv">1500</span>,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">parallel_chains =</span> <span class="dv">4</span>,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">seed =</span> <span class="dv">1234</span>,</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">refresh =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 finished in 68.4 seconds.
Chain 4 finished in 71.5 seconds.
Chain 3 finished in 72.8 seconds.
Chain 2 finished in 77.0 seconds.

All 4 chains finished successfully.
Mean chain execution time: 72.4 seconds.
Total execution time: 77.2 seconds.</code></pre>
</div>
</div>
<p>La estimación del parámetro <span class="math inline">\(B\)</span> es:</p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-38_789c97b873ceec7523ae5bae6edd9726">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>model_Losgit2<span class="sc">$</span><span class="fu">summary</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"beta"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 8%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 9%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">mad</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
<th style="text-align: right;">rhat</th>
<th style="text-align: right;">ess_bulk</th>
<th style="text-align: right;">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">beta[1]</td>
<td style="text-align: right;">-3.3332348</td>
<td style="text-align: right;">-3.2536650</td>
<td style="text-align: right;">0.7908788</td>
<td style="text-align: right;">0.7840582</td>
<td style="text-align: right;">-4.7045565</td>
<td style="text-align: right;">-2.1873560</td>
<td style="text-align: right;">1.026023</td>
<td style="text-align: right;">220.7655</td>
<td style="text-align: right;">284.4963</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[2]</td>
<td style="text-align: right;">0.0757540</td>
<td style="text-align: right;">0.0725971</td>
<td style="text-align: right;">0.1847678</td>
<td style="text-align: right;">0.1862678</td>
<td style="text-align: right;">-0.2233134</td>
<td style="text-align: right;">0.3878363</td>
<td style="text-align: right;">1.004140</td>
<td style="text-align: right;">563.9095</td>
<td style="text-align: right;">1110.9357</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta[3]</td>
<td style="text-align: right;">1.9745658</td>
<td style="text-align: right;">1.8837500</td>
<td style="text-align: right;">0.8001186</td>
<td style="text-align: right;">0.7752441</td>
<td style="text-align: right;">0.8340352</td>
<td style="text-align: right;">3.3609075</td>
<td style="text-align: right;">1.026622</td>
<td style="text-align: right;">227.2871</td>
<td style="text-align: right;">275.5769</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[4]</td>
<td style="text-align: right;">1.1197877</td>
<td style="text-align: right;">1.0228750</td>
<td style="text-align: right;">0.7912913</td>
<td style="text-align: right;">0.7782983</td>
<td style="text-align: right;">0.0017313</td>
<td style="text-align: right;">2.5057440</td>
<td style="text-align: right;">1.026696</td>
<td style="text-align: right;">224.8613</td>
<td style="text-align: right;">263.6050</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta[5]</td>
<td style="text-align: right;">-1.0165700</td>
<td style="text-align: right;">-1.0496550</td>
<td style="text-align: right;">1.0015232</td>
<td style="text-align: right;">1.0003176</td>
<td style="text-align: right;">-2.6053630</td>
<td style="text-align: right;">0.6687550</td>
<td style="text-align: right;">1.018563</td>
<td style="text-align: right;">286.2922</td>
<td style="text-align: right;">440.5527</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[6]</td>
<td style="text-align: right;">-0.2392411</td>
<td style="text-align: right;">-0.2278820</td>
<td style="text-align: right;">0.2298685</td>
<td style="text-align: right;">0.2288670</td>
<td style="text-align: right;">-0.6327349</td>
<td style="text-align: right;">0.1221797</td>
<td style="text-align: right;">1.005465</td>
<td style="text-align: right;">451.8669</td>
<td style="text-align: right;">847.1253</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta[7]</td>
<td style="text-align: right;">-1.6516955</td>
<td style="text-align: right;">-1.6554500</td>
<td style="text-align: right;">0.2661331</td>
<td style="text-align: right;">0.2558004</td>
<td style="text-align: right;">-2.0853870</td>
<td style="text-align: right;">-1.2109930</td>
<td style="text-align: right;">1.004583</td>
<td style="text-align: right;">531.2064</td>
<td style="text-align: right;">906.6342</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[8]</td>
<td style="text-align: right;">-4.0522629</td>
<td style="text-align: right;">-4.0037350</td>
<td style="text-align: right;">0.6539552</td>
<td style="text-align: right;">0.6406685</td>
<td style="text-align: right;">-5.1874125</td>
<td style="text-align: right;">-3.0579680</td>
<td style="text-align: right;">1.001956</td>
<td style="text-align: right;">458.5598</td>
<td style="text-align: right;">681.3590</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-39_3f9252c21ef09aec2a37eb8aa0b20e07">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(model_Losgit2<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"beta"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-40_e59d0c12283e7b9814808ea6ef4b00db">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(model_Losgit2<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"beta"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-41_e5a1c407fc57c90f3bf66fbd423e2acd">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>y_pred_B <span class="ot">&lt;-</span> model_Losgit2<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="st">"ypred"</span>, <span class="at">format =</span> <span class="st">"matrix"</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>rowsrandom <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(y_pred_B), <span class="dv">100</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>y_pred2 <span class="ot">&lt;-</span> y_pred_B[rowsrandom, ]</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ppc_dens_overlay</span>(<span class="at">y =</span> <span class="fu">as.numeric</span>(datalogit<span class="sc">$</span>pobreza), y_pred2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="modelo-binomial" class="level2">
<h2 class="anchored" data-anchor-id="modelo-binomial">Modelo Binomial</h2>
<p>En este caso la variable respuesta representa conteos de éxitos que se tuvieron en un conjunto de distintos experimentos. Se supone que <span class="math inline">\(\mathbf{Y}=\{Y_1, \ldots, Y_n\}\)</span> es un conjunto de variables aleatorias intercambiables cada una con distribución binomial de parámetro <span class="math inline">\(\theta_i\)</span> y <span class="math inline">\(n_i\)</span>. El modelo binomial busca relacionar las probabilidades de éxito <span class="math inline">\(\theta_i\)</span> con variables auxiliares <span class="math inline">\(\mathbf{X}_i\)</span>. Se considera a continuación la función de enlace logística.</p>
<p>La función de vínculo logística dada por <span class="math inline">\(g(\theta_i)=\log\left(\frac{\theta_i}{1-\theta_i}\right)\)</span>, y denotando <span class="math inline">\(\eta_i=\mathbf{X}_i'\boldsymbol{\beta}=g(\theta_i)\)</span>, se tiene que la verosimilitud de los datos está dada por</p>
<p><span class="math display">\[
\begin{align}
p(\mathbf{Y}\mid \boldsymbol{\theta})&amp;=\prod_{i=1}^n\binom{n}{y_i}\theta_i^{y_i}(1-\theta_i)^{n-y_i} \notag \\
&amp;=\prod_{i=1}^n\binom{n}{y_i}\left(\frac{\exp(\mathbf{X}_i'\boldsymbol{\beta})}{1+\exp(\mathbf{X}_i'\boldsymbol{\beta})}\right)^{y_i}
\left(1-\left(\frac{\exp(\mathbf{X}_i'\boldsymbol{\beta})}{1+\exp(\mathbf{X}_i'\boldsymbol{\beta})}\right)\right)^{n-y_i}
\end{align}
\]</span> Suponga que la distribución a previa para <span class="math inline">\(\boldsymbol{\beta}\)</span> está regida por la siguiente estructura probabilística</p>
<p><span class="math display">\[
\begin{equation*}
\boldsymbol{\beta}\sim N_q(\mathbf{b},\mathbf{B})
\end{equation*}
\]</span> De esta manera, la distribución a posterior toma la siguiente forma.</p>
<p><span class="math display">\[
\begin{align*}
p(\boldsymbol{\beta} \mid \mathbf{Y}, \mathbf{X})&amp;\propto
\prod_{i=1}^n\left(\frac{\exp(\mathbf{X}_i'\boldsymbol{\beta})}{1+\exp(\mathbf{X}_i'\boldsymbol{\beta})}\right)^{y_i}
\left(1-\left(\frac{\exp(\mathbf{X}_i'\boldsymbol{\beta})}{1+\exp(\mathbf{X}_i'\boldsymbol{\beta})}\right)\right)^{n-y_i}\\
&amp;\hspace{2cm}\times
\exp\left\{\frac{-1}{2}(\boldsymbol{\beta}-\mathbf{b})'\mathbf{B}^{-1}(\boldsymbol{\beta}-\mathbf{b})\right\}
\end{align*}
\]</span></p>
<p>Una vez más, la anterior expresión no tiene una forma cerrada.</p>
<section id="práctica-en-stan-1" class="level3">
<h3 class="anchored" data-anchor-id="práctica-en-stan-1">Práctica en <code>STAN</code></h3>
<p>Datos de la encuesta</p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-42_da9417eda7fa5023b50329e03c789ae2">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>dataBino <span class="ot">&lt;-</span> encuesta <span class="sc">%&gt;%</span> </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">depto =</span> <span class="fu">str_pad</span>(</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">string =</span> dpto,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">pad =</span> <span class="st">"0"</span>,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">width =</span> <span class="dv">2</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">pobreza =</span> <span class="fu">ifelse</span>(ingcorte <span class="sc">&lt;</span> lp, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(depto) <span class="sc">%&gt;%</span> </span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>() ,                  <span class="co"># Número de ensayos</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">nPobreza =</span> <span class="fu">sum</span>(pobreza)    <span class="co"># número de exitos </span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span>                      <span class="co"># covariables  </span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(tasa_desocupacion, <span class="at">by =</span> <span class="st">"depto"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(depto))</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dataBino)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 11%">
<col style="width: 22%">
<col style="width: 18%">
<col style="width: 17%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">depto</th>
<th style="text-align: right;">n</th>
<th style="text-align: right;">nPobreza</th>
<th style="text-align: right;">tasa_desocupacion</th>
<th style="text-align: right;">Luces_nocturna</th>
<th style="text-align: right;">Suelo_cultivo</th>
<th style="text-align: right;">Suelo_urbano</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">01</td>
<td style="text-align: right;">42930</td>
<td style="text-align: right;">575</td>
<td style="text-align: right;">0.0666792</td>
<td style="text-align: right;">29595.102</td>
<td style="text-align: right;">6008.267</td>
<td style="text-align: right;">27716.573</td>
</tr>
<tr class="even">
<td style="text-align: left;">02</td>
<td style="text-align: right;">2432</td>
<td style="text-align: right;">167</td>
<td style="text-align: right;">0.0615587</td>
<td style="text-align: right;">5042.455</td>
<td style="text-align: right;">96538.694</td>
<td style="text-align: right;">2789.773</td>
</tr>
<tr class="odd">
<td style="text-align: left;">03</td>
<td style="text-align: right;">18606</td>
<td style="text-align: right;">530</td>
<td style="text-align: right;">0.0696271</td>
<td style="text-align: right;">61932.553</td>
<td style="text-align: right;">191183.137</td>
<td style="text-align: right;">24827.843</td>
</tr>
<tr class="even">
<td style="text-align: left;">04</td>
<td style="text-align: right;">2937</td>
<td style="text-align: right;">144</td>
<td style="text-align: right;">0.0647848</td>
<td style="text-align: right;">6373.506</td>
<td style="text-align: right;">282859.039</td>
<td style="text-align: right;">4045.102</td>
</tr>
<tr class="odd">
<td style="text-align: left;">05</td>
<td style="text-align: right;">4512</td>
<td style="text-align: right;">85</td>
<td style="text-align: right;">0.0418771</td>
<td style="text-align: right;">17658.996</td>
<td style="text-align: right;">413940.753</td>
<td style="text-align: right;">7373.220</td>
</tr>
<tr class="even">
<td style="text-align: left;">06</td>
<td style="text-align: right;">2395</td>
<td style="text-align: right;">77</td>
<td style="text-align: right;">0.0565903</td>
<td style="text-align: right;">8937.016</td>
<td style="text-align: right;">260584.235</td>
<td style="text-align: right;">3485.773</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Creando código de <code>STAN</code></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-43_5411121c8439531ffd675b582765e2cf">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>data {</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> D;   <span class="sc">/</span><span class="er">/</span> Número de observaciones</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> K;   <span class="sc">/</span><span class="er">/</span> Número de predictores</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> nd[D];  <span class="sc">/</span><span class="er">/</span> Número de ensayos</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> yd[D];   <span class="sc">/</span><span class="er">/</span> Número de exitos</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  matrix[D, K] x;   <span class="sc">/</span><span class="er">/</span> Matrix de predictores</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>parameters {</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  vector[K] beta;       <span class="sc">/</span><span class="er">/</span> coefficients <span class="cf">for</span> predictors</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>transformed parameters {</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>   vector[D] eta;</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>   eta <span class="ot">=</span>  x <span class="sc">*</span> beta;</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>model {</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">to_vector</span>(beta) <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">10000</span>);</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>  yd <span class="sc">~</span> <span class="fu">binomial_logit</span>(nd, eta);  <span class="sc">/</span><span class="er">/</span> likelihood</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>generated quantities {</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>    real ypred[D];                    <span class="sc">/</span><span class="er">/</span> vector de longitud n</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>  ypred <span class="ot">=</span> <span class="fu">binomial_rng</span>(nd, <span class="fu">inv_logit</span>(eta));  </span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Preparando el código de <code>STAN</code></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-44_894870760fe68232ab92133b6e07e477">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>fitBinomial <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="at">stan_file =</span> <span class="st">"../Data/modelosStan/ModeloBinomial.stan"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Organizando datos para <code>STAN</code></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-45_65c9787766f15c30f56b49dbddc8020d">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>Xdat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(nPobreza <span class="sc">~</span>  </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>                       Luces_nocturna <span class="sc">+</span> </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>                       Suelo_cultivo <span class="sc">+</span> Suelo_urbano,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> dataBino)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>Xdat <span class="ot">=</span> <span class="fu">as.matrix</span>(Xdat)<span class="sc">/</span><span class="dv">100000</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>Xdat[,<span class="dv">1</span>]<span class="ot">&lt;-</span><span class="dv">1</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Xdat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: right;">(Intercept)</th>
<th style="text-align: right;">Luces_nocturna</th>
<th style="text-align: right;">Suelo_cultivo</th>
<th style="text-align: right;">Suelo_urbano</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.2959510</td>
<td style="text-align: right;">0.0600827</td>
<td style="text-align: right;">0.2771657</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0504245</td>
<td style="text-align: right;">0.9653869</td>
<td style="text-align: right;">0.0278977</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.6193255</td>
<td style="text-align: right;">1.9118314</td>
<td style="text-align: right;">0.2482784</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0637351</td>
<td style="text-align: right;">2.8285904</td>
<td style="text-align: right;">0.0404510</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.1765900</td>
<td style="text-align: right;">4.1394075</td>
<td style="text-align: right;">0.0737322</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0893702</td>
<td style="text-align: right;">2.6058424</td>
<td style="text-align: right;">0.0348577</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-46_5976502c5856fce0c55c137796d5cc13">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>sample_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">D =</span> <span class="fu">nrow</span>(dataBino),</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">K =</span> <span class="fu">ncol</span>(Xdat),</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">x =</span> <span class="fu">as.matrix</span>(Xdat),</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">yd =</span> dataBino<span class="sc">$</span>nPobreza,</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">nd =</span> dataBino<span class="sc">$</span>n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para ejecutar <code>STAN</code> en R tenemos la librería <em>cmdstanr</em></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-47_b976c195768ab4a2be06cd9e3e938c3c">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>model_Binomial <span class="ot">&lt;-</span> fitBinomial<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> sample_data, </span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">parallel_chains =</span> <span class="dv">4</span>,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">seed =</span> <span class="dv">1234</span>,</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">refresh =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 finished in 0.8 seconds.
Chain 2 finished in 0.8 seconds.
Chain 3 finished in 1.0 seconds.
Chain 4 finished in 1.0 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.9 seconds.
Total execution time: 1.2 seconds.</code></pre>
</div>
</div>
<p>La estimación del parámetro <span class="math inline">\(B\)</span> es:</p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-48_7f8d431d09882c5ee1c27efa33e21c6b">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>model_Binomial<span class="sc">$</span><span class="fu">summary</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"beta"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 9%">
<col style="width: 11%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">mad</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
<th style="text-align: right;">rhat</th>
<th style="text-align: right;">ess_bulk</th>
<th style="text-align: right;">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">beta[1]</td>
<td style="text-align: right;">-2.7445356</td>
<td style="text-align: right;">-2.744495</td>
<td style="text-align: right;">0.0590749</td>
<td style="text-align: right;">0.0599638</td>
<td style="text-align: right;">-2.8428050</td>
<td style="text-align: right;">-2.6485960</td>
<td style="text-align: right;">1.002497</td>
<td style="text-align: right;">1385.848</td>
<td style="text-align: right;">1656.870</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[2]</td>
<td style="text-align: right;">1.8386581</td>
<td style="text-align: right;">1.839420</td>
<td style="text-align: right;">0.1862255</td>
<td style="text-align: right;">0.1889500</td>
<td style="text-align: right;">1.5240600</td>
<td style="text-align: right;">2.1387270</td>
<td style="text-align: right;">1.002705</td>
<td style="text-align: right;">1188.089</td>
<td style="text-align: right;">1419.861</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta[3]</td>
<td style="text-align: right;">-0.1218676</td>
<td style="text-align: right;">-0.121811</td>
<td style="text-align: right;">0.0184392</td>
<td style="text-align: right;">0.0181982</td>
<td style="text-align: right;">-0.1517055</td>
<td style="text-align: right;">-0.0918095</td>
<td style="text-align: right;">1.002686</td>
<td style="text-align: right;">1291.902</td>
<td style="text-align: right;">1841.062</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[4]</td>
<td style="text-align: right;">-7.4088571</td>
<td style="text-align: right;">-7.416235</td>
<td style="text-align: right;">0.3950512</td>
<td style="text-align: right;">0.4052391</td>
<td style="text-align: right;">-8.0311515</td>
<td style="text-align: right;">-6.7477395</td>
<td style="text-align: right;">1.001540</td>
<td style="text-align: right;">1092.597</td>
<td style="text-align: right;">1389.414</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-49_ef3dfbedf462ef40e0e0d014670ef555">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(model_Binomial<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"beta"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-50_cbbb6f42de4f7f7a2e48dbf3647c0ddd">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(model_Binomial<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"beta"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-51_8f8fb5e3afe4eea26e478aaf34bf9570">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>y_pred_B <span class="ot">&lt;-</span> model_Binomial<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="st">"ypred"</span>, <span class="at">format =</span> <span class="st">"matrix"</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>rowsrandom <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(y_pred_B), <span class="dv">100</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>y_pred2 <span class="ot">&lt;-</span> y_pred_B[rowsrandom, ]</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ppc_dens_overlay</span>(<span class="at">y =</span> <span class="fu">as.numeric</span>(dataBino<span class="sc">$</span>nPobreza), y_pred2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="regresión-multinomial-con-vínculo-logit" class="level2">
<h2 class="anchored" data-anchor-id="regresión-multinomial-con-vínculo-logit">Regresión multinomial con vínculo logit</h2>
<p>La distribución multinomial es una extensión de la distribución binomial, esta se aplica en situaciones donde hay un número fijo de ensayos independientes, donde cada el resultado de cada ensayo corresponde a una de <span class="math inline">\(K\)</span> categorías.</p>
<p>Generalizando lo anterior, se considera <span class="math inline">\(\mathbf{Y}=\{\mathbf{Y}_1, \ldots, \mathbf{Y}_n\}\)</span> un conjunto de vectores aleatorios intercambiables cada una con distribución multinomial de parámetros <span class="math inline">\((n_i, \boldsymbol{\theta}_i)\)</span>. Note que todos lo vectores tienen <span class="math inline">\(K\)</span> categorias; en particular, el <span class="math inline">\(i\)</span>-ésimo vector del conjunto se define como <span class="math inline">\(\mathbf{Y}_i=(Y_{i1}, \ldots, Y_{iK})'\)</span>, el vector de parámetros de interés es <span class="math inline">\(\boldsymbol{\theta}_i=(\theta_{i1},\ldots, \theta_{iK})\)</span> con <span class="math inline">\(\sum_{k=1}^K\theta_{ik}=1\)</span>, y <span class="math inline">\(n_i=\sum_{k=1}^K Y_{ik}\)</span>, y por ende se tiene que la distribución, condicional a <span class="math inline">\(n_i\)</span>, de <span class="math inline">\(\mathbf{Y}_{i}\)</span> sigue una distribución multinomial tal que:</p>
<p><span class="math display">\[
\begin{equation}
p(\mathbf{Y}_{i}\mid n_i, \boldsymbol{\theta}_i)=\binom{n_i}{y_{i1}, \ldots, y_{iK}}\prod_{k=1}^K\theta_{ik}^{y_{ik}}
\end{equation}
\]</span></p>
<p>Con base en lo anterior, la verosimilitud de los datos se tiene mediante la siguiente expresión</p>
<p><span class="math display">\[
\begin{equation}
p(\mathbf{Y} \mid n, \boldsymbol{\theta})=\prod_{i=1}^n \binom{n_i}{y_{i1}, \ldots, y_{iK}}\prod_{k=1}^K\theta_{ik}^{y_{ik}}
\end{equation}
\]</span></p>
<p>Antes de proseguir con el modelamiento bayesiano, es útil notar que en este caso el vínculo no es un vector sino una matriz que responde a una relación lineal entre las covariables y una matriz de coeficientes de regresión, como se puede ver a continuación.</p>
<p><span class="math display">\[
\begin{equation*}
\begin{bmatrix}
  \eta_{11} &amp; \eta_{12} &amp; \cdots &amp; \eta_{1K} \\
  \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
  \eta_{n1} &amp; \eta_{n2} &amp; \cdots &amp; \eta_{nK}
\end{bmatrix}
=
\begin{bmatrix}
  X_{11} &amp; X_{12} &amp; \cdots &amp; X_{1q} \\
  \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
  X_{n1} &amp; X_{n2} &amp; \cdots &amp; X_{nq}
\end{bmatrix}
\begin{bmatrix}
  \beta_{11} &amp; \beta_{12} &amp; \cdots &amp; \beta_{1K} \\
  \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
  \beta_{q1} &amp; \beta_{q2} &amp; \cdots &amp; \beta_{qK}
\end{bmatrix}
\end{equation*}
\]</span></p>
<p>Es decir, <span class="math display">\[
\begin{equation}
\boldsymbol{\eta}=\mathbf{X}'\boldsymbol{\beta}
\end{equation}
\]</span></p>
<p>Lo anterior conlleva a que <span class="math inline">\(\eta_{ik}=\mathbf{X}_i'\boldsymbol{\beta}_k\)</span>, donde <span class="math inline">\(\mathbf{X}_i\)</span> es la <span class="math inline">\(i\)</span>-ésima fila de la matriz <span class="math inline">\(\mathbf{X}\)</span> y <span class="math inline">\(\boldsymbol{\beta}_k\)</span> es la <span class="math inline">\(k\)</span>-ésima columna de la matriz <span class="math inline">\(\boldsymbol{\beta}\)</span>. Ahora, tomando como línea de base la primera columnna de la matriz <span class="math inline">\(\boldsymbol{\eta}\)</span> (es decir, el vector de las probabilidades de la categoría 1 para los <span class="math inline">\(n\)</span> individuos), y utilizando la función de vinculo logístico, se tiene que para los elementos en las restantes columnnas de <span class="math inline">\(\boldsymbol{\eta}\)</span>,</p>
<p><span class="math display">\[
\begin{equation}
\eta_{ik}=g(\theta_{ik})=\log\left(\frac{\theta_{ik}}{\theta_{i1}}\right)=\log\left(\frac{\theta_{ik}}{\theta_{i1}}\right)
\end{equation}
\]</span> Con un poco de álgebra se comprueba que la función inversa para <span class="math inline">\(g(\cdot)\)</span> está dada por la siguiente expresión <span class="math display">\[
\begin{equation}
\theta_{ik}=g^{-1}(\eta_{ik})=\theta_{i1}\exp(\eta_{ik}) \ \ \ \ \ \forall k=2,\ldots,K
\end{equation}
\]</span></p>
<p>Ahora, para la primera columna de <span class="math inline">\(\boldsymbol{\eta}\)</span>, es decir, el vector de probabilidades de la primera categoría, se tiene que</p>
<p><span class="math display">\[
\begin{equation*}
\theta_{i1}=1-\sum_{j=2}^K\theta_{ij}=1-\sum_{j=2}^K\theta_{i1}\exp(\eta_{ij})
\end{equation*}
\]</span></p>
<p>de donde se tiene que</p>
<p><span class="math display">\[
\begin{equation}
\theta_{i1}=\frac{1}{1+\sum_{j=2}^K\exp(\eta_{ij})}
\end{equation}
\]</span></p>
<p>Finalmente, se tiene que <span class="math display">\[
\begin{equation*}
\theta_{ik}=\frac{\exp(\eta_{ik})}{1+\sum_{k=2}^K\exp(\eta_{ik})} \ \ \ \ \forall k=1,\ldots,K
\end{equation*}
\]</span></p>
<p>con <span class="math inline">\(\boldsymbol{\beta}_1=0\)</span>, esto es <span class="math inline">\(\eta_{i1}=0\)</span> para todo <span class="math inline">\(i\)</span>. Notando que <span class="math inline">\(\eta_{ik}=\mathbf{X}_i'\boldsymbol{\beta}_k\)</span>, se tiene que la verosimilitud de los datos toma la siguiente forma</p>
<p><span class="math display">\[
\begin{align*}
p(\mathbf{Y} \mid n, \boldsymbol{\theta})=&amp;\prod_{i=1}^n \binom{n_i}{y_{i1}, \ldots, y_{iK}}\prod_{k=1}^K\theta_{ik}^{y_{ik}}\\
p(\mathbf{Y} \mid n, \boldsymbol{\beta})=&amp;\prod_{i=1}^n \binom{n_i}{y_{i1}, \ldots, y_{iK}}
\prod_{k=1}^K\left(\frac{\exp(\mathbf{X}_i'\boldsymbol{\beta}_k)}{1+\sum_{k=2}^K\exp(\mathbf{X}_i'\boldsymbol{\beta}_k)}\right)^{y_{ik}}\\
\end{align*}
\]</span></p>
<p>Suponiendo que la distribución a priori para <span class="math inline">\(\boldsymbol{\beta}_k\)</span> está regida por la siguiente estructura probabilística <span class="math display">\[
\begin{equation*}
\boldsymbol{\beta}_k\sim N_q(\mathbf{b}_k,\mathbf{B}_k)
\end{equation*}
\]</span></p>
<p>De esta manera, la distribución a posteriori para el <span class="math inline">\(k\)</span> ésimo vector <span class="math inline">\(\boldsymbol{\beta}_k\)</span> toma la siguiente forma.</p>
<p><span class="math display">\[
\begin{align*}
p(\boldsymbol{\beta}_k \mid \mathbf{Y}, \mathbf{X}, n)&amp;\propto
\prod_{i=1}^n \left(\frac{\exp(\mathbf{X}_i'\boldsymbol{\beta}_k)}{1+\sum_{k=2}^K\exp(\mathbf{X}_i'\boldsymbol{\beta}_k)}\right)^{y_{ik}}\\
&amp;\hspace{2cm}\times
\exp\left\{-\frac{1}{2}(\boldsymbol{\beta}-\mathbf{b})'\mathbf{B}^{-1}(\boldsymbol{\beta}-\mathbf{b})\right\}
\end{align*}
\]</span></p>
<p>Una vez más, la anterior expresión no tiene una forma cerrada.</p>
<section id="práctica-en-stan-2" class="level3">
<h3 class="anchored" data-anchor-id="práctica-en-stan-2">Práctica en <code>STAN</code></h3>
<p>Datos de la encuesta</p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-52_4627ff4d301e973a2d60dce79b2c2fe9">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>dataMultinomial <span class="ot">&lt;-</span> encuesta <span class="sc">%&gt;%</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(edad <span class="sc">&gt;=</span> <span class="dv">18</span>, condact3 <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">depto =</span> <span class="fu">str_pad</span>(</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">string =</span> dpto,</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">pad =</span> <span class="st">"0"</span>,</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">width =</span> <span class="dv">2</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">empleo =</span> <span class="fu">as_factor</span>(condact3),</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(depto, empleo) <span class="sc">%&gt;%</span> </span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>   <span class="fu">tally</span>() <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>()</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>dataMultinomial <span class="ot">&lt;-</span> dataMultinomial <span class="sc">%&gt;%</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread</span>(<span class="at">key =</span> <span class="st">"empleo"</span>,<span class="at">value =</span> <span class="st">"n"</span>, <span class="at">fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a> <span class="fu">inner_join</span>(tasa_desocupacion, <span class="at">by =</span> <span class="st">"depto"</span>)</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dataMultinomial)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 6%">
<col style="width: 8%">
<col style="width: 11%">
<col style="width: 9%">
<col style="width: 19%">
<col style="width: 15%">
<col style="width: 14%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">depto</th>
<th style="text-align: right;">Ocupado</th>
<th style="text-align: right;">Desocupado</th>
<th style="text-align: right;">Inactivo</th>
<th style="text-align: right;">tasa_desocupacion</th>
<th style="text-align: right;">Luces_nocturna</th>
<th style="text-align: right;">Suelo_cultivo</th>
<th style="text-align: right;">Suelo_urbano</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">01</td>
<td style="text-align: right;">25182</td>
<td style="text-align: right;">2194</td>
<td style="text-align: right;">15554</td>
<td style="text-align: right;">0.0666792</td>
<td style="text-align: right;">29595.102</td>
<td style="text-align: right;">6008.267</td>
<td style="text-align: right;">27716.573</td>
</tr>
<tr class="even">
<td style="text-align: left;">02</td>
<td style="text-align: right;">1298</td>
<td style="text-align: right;">141</td>
<td style="text-align: right;">993</td>
<td style="text-align: right;">0.0615587</td>
<td style="text-align: right;">5042.455</td>
<td style="text-align: right;">96538.694</td>
<td style="text-align: right;">2789.773</td>
</tr>
<tr class="odd">
<td style="text-align: left;">03</td>
<td style="text-align: right;">10423</td>
<td style="text-align: right;">1217</td>
<td style="text-align: right;">6966</td>
<td style="text-align: right;">0.0696271</td>
<td style="text-align: right;">61932.553</td>
<td style="text-align: right;">191183.137</td>
<td style="text-align: right;">24827.843</td>
</tr>
<tr class="even">
<td style="text-align: left;">04</td>
<td style="text-align: right;">1547</td>
<td style="text-align: right;">145</td>
<td style="text-align: right;">1245</td>
<td style="text-align: right;">0.0647848</td>
<td style="text-align: right;">6373.506</td>
<td style="text-align: right;">282859.039</td>
<td style="text-align: right;">4045.102</td>
</tr>
<tr class="odd">
<td style="text-align: left;">05</td>
<td style="text-align: right;">2449</td>
<td style="text-align: right;">209</td>
<td style="text-align: right;">1854</td>
<td style="text-align: right;">0.0418771</td>
<td style="text-align: right;">17658.996</td>
<td style="text-align: right;">413940.753</td>
<td style="text-align: right;">7373.220</td>
</tr>
<tr class="even">
<td style="text-align: left;">06</td>
<td style="text-align: right;">1307</td>
<td style="text-align: right;">177</td>
<td style="text-align: right;">911</td>
<td style="text-align: right;">0.0565903</td>
<td style="text-align: right;">8937.016</td>
<td style="text-align: right;">260584.235</td>
<td style="text-align: right;">3485.773</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Creando código de <code>STAN</code></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-53_ff4a8b5f4377ab9d4580ca10f81f5e7b">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>data {</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">1</span><span class="sc">&gt;</span> D;    <span class="sc">/</span><span class="er">/</span> número de postestrto </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">1</span><span class="sc">&gt;</span> P;    <span class="sc">/</span><span class="er">/</span> categorías</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">1</span><span class="sc">&gt;</span> K;  <span class="sc">/</span><span class="er">/</span> cantidad de regresores</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  int y[D, P];       <span class="sc">/</span><span class="er">/</span> matriz de datos</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  matrix[D, K] X; <span class="sc">/</span><span class="er">/</span> matriz de covariables</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>parameters {</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  matrix[P<span class="dv">-1</span>, K] beta;<span class="sc">/</span><span class="er">/</span> matriz de parámetros </span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>transformed parameters {</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>  simplex[P] theta[D];<span class="sc">/</span><span class="er">/</span> vector de parámetros;</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>  real num[D, P];</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>  real den[D];</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(d <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>D){</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>    num[d, <span class="dv">1</span>] <span class="ot">=</span> <span class="dv">1</span>;</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>    num[d, <span class="dv">2</span>] <span class="ot">=</span> <span class="fu">exp</span>(X[d, ] <span class="sc">*</span> beta[<span class="dv">1</span>, ]<span class="st">') ;</span></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a><span class="st">    num[d, 3] = exp(X[d, ] * beta[2, ]'</span>) ;</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>    den[d] <span class="ot">=</span> <span class="fu">sum</span>(num[d, ]);</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(d <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>D){</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(p <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>P){</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>    theta[d, p] <span class="ot">=</span> num[d, p]<span class="sc">/</span>den[d];</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>    theta[d, <span class="dv">1</span>] <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>den[d];</span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>model {</span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">to_vector</span>(beta) <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">100</span>);</span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(d <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>D){</span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>    target <span class="sc">+</span><span class="er">=</span> <span class="fu">multinomial_lpmf</span>(y[d, ] <span class="sc">|</span> theta[d, ]); </span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Preparando el código de <code>STAN</code></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-54_fafc73844567392609df7baf7a8ddb1b">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>fitMultinomial <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="at">stan_file =</span> <span class="st">"../Data/modelosStan/ModeloMultinomial.stan"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Organizando datos para <code>STAN</code></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-55_6f39377305446d7e1369e04d5031b1c9">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>Xdat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(Ocupado <span class="sc">~</span> tasa_desocupacion <span class="sc">+</span> Luces_nocturna <span class="sc">+</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>Suelo_cultivo <span class="sc">+</span> Suelo_urbano  ,</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> dataMultinomial)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>Xdat[,<span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>] <span class="ot">&lt;-</span> Xdat[,<span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>]<span class="sc">/</span><span class="dv">100000</span>  </span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Xdat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 16%">
<col style="width: 25%">
<col style="width: 20%">
<col style="width: 19%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">(Intercept)</th>
<th style="text-align: right;">tasa_desocupacion</th>
<th style="text-align: right;">Luces_nocturna</th>
<th style="text-align: right;">Suelo_cultivo</th>
<th style="text-align: right;">Suelo_urbano</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0666792</td>
<td style="text-align: right;">0.2959510</td>
<td style="text-align: right;">0.0600827</td>
<td style="text-align: right;">0.2771657</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0615587</td>
<td style="text-align: right;">0.0504245</td>
<td style="text-align: right;">0.9653869</td>
<td style="text-align: right;">0.0278977</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0696271</td>
<td style="text-align: right;">0.6193255</td>
<td style="text-align: right;">1.9118314</td>
<td style="text-align: right;">0.2482784</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0647848</td>
<td style="text-align: right;">0.0637351</td>
<td style="text-align: right;">2.8285904</td>
<td style="text-align: right;">0.0404510</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0418771</td>
<td style="text-align: right;">0.1765900</td>
<td style="text-align: right;">4.1394075</td>
<td style="text-align: right;">0.0737322</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0565903</td>
<td style="text-align: right;">0.0893702</td>
<td style="text-align: right;">2.6058424</td>
<td style="text-align: right;">0.0348577</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-56_ab8dba0f874ea508718d271b44a7c9ad">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>ydat <span class="ot">&lt;-</span> dataMultinomial <span class="sc">%&gt;%</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Ocupado, Desocupado, Inactivo) <span class="sc">%&gt;%</span> </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ydat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: right;">Ocupado</th>
<th style="text-align: right;">Desocupado</th>
<th style="text-align: right;">Inactivo</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">25182</td>
<td style="text-align: right;">2194</td>
<td style="text-align: right;">15554</td>
</tr>
<tr class="even">
<td style="text-align: right;">1298</td>
<td style="text-align: right;">141</td>
<td style="text-align: right;">993</td>
</tr>
<tr class="odd">
<td style="text-align: right;">10423</td>
<td style="text-align: right;">1217</td>
<td style="text-align: right;">6966</td>
</tr>
<tr class="even">
<td style="text-align: right;">1547</td>
<td style="text-align: right;">145</td>
<td style="text-align: right;">1245</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2449</td>
<td style="text-align: right;">209</td>
<td style="text-align: right;">1854</td>
</tr>
<tr class="even">
<td style="text-align: right;">1307</td>
<td style="text-align: right;">177</td>
<td style="text-align: right;">911</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-57_434ad1f66675cd5e5f9023100a5edb25">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>sample_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">D =</span> <span class="fu">nrow</span>(dataMultinomial),</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">K =</span> <span class="fu">ncol</span>(Xdat),</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">X =</span> <span class="fu">as.matrix</span>(Xdat),</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">P =</span> <span class="fu">ncol</span>(ydat),</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">y =</span> ydat</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>                    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para ejecutar <code>STAN</code> en R tenemos la librería <em>cmdstanr</em></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-58_d82d6329f22ba4a7ed51d47634ae288e">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>model_Multinomial <span class="ot">&lt;-</span> fitMultinomial<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> sample_data, </span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">num_samples =</span> <span class="dv">1000</span>,</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">num_warmup =</span> <span class="dv">3000</span>,</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">parallel_chains =</span> <span class="dv">4</span>,</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">seed =</span> <span class="dv">1234</span>,</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">refresh =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 2 finished in 20.5 seconds.
Chain 3 finished in 20.7 seconds.
Chain 4 finished in 20.7 seconds.
Chain 1 finished in 21.4 seconds.

All 4 chains finished successfully.
Mean chain execution time: 20.8 seconds.
Total execution time: 21.5 seconds.</code></pre>
</div>
</div>
<p>La estimación del parámetro <span class="math inline">\(B\)</span> es:</p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-59_52b4e499a0688dc02889182d1a15862f">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>model_Multinomial<span class="sc">$</span><span class="fu">summary</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"beta"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 8%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">mad</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
<th style="text-align: right;">rhat</th>
<th style="text-align: right;">ess_bulk</th>
<th style="text-align: right;">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">beta[1,1]</td>
<td style="text-align: right;">-2.7631160</td>
<td style="text-align: right;">-2.7651550</td>
<td style="text-align: right;">0.1561829</td>
<td style="text-align: right;">0.1538865</td>
<td style="text-align: right;">-3.0257915</td>
<td style="text-align: right;">-2.5038660</td>
<td style="text-align: right;">1.003299</td>
<td style="text-align: right;">1728.285</td>
<td style="text-align: right;">1836.273</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[2,1]</td>
<td style="text-align: right;">-0.3217239</td>
<td style="text-align: right;">-0.3223580</td>
<td style="text-align: right;">0.0724355</td>
<td style="text-align: right;">0.0745822</td>
<td style="text-align: right;">-0.4386742</td>
<td style="text-align: right;">-0.2019735</td>
<td style="text-align: right;">1.003412</td>
<td style="text-align: right;">1818.229</td>
<td style="text-align: right;">2168.713</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta[1,2]</td>
<td style="text-align: right;">8.4814945</td>
<td style="text-align: right;">8.4759550</td>
<td style="text-align: right;">2.4520060</td>
<td style="text-align: right;">2.4365197</td>
<td style="text-align: right;">4.3680355</td>
<td style="text-align: right;">12.5462950</td>
<td style="text-align: right;">1.004375</td>
<td style="text-align: right;">2133.414</td>
<td style="text-align: right;">1748.726</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[2,2]</td>
<td style="text-align: right;">1.5071402</td>
<td style="text-align: right;">1.5355950</td>
<td style="text-align: right;">1.1434878</td>
<td style="text-align: right;">1.1468875</td>
<td style="text-align: right;">-0.3618738</td>
<td style="text-align: right;">3.3667055</td>
<td style="text-align: right;">1.002910</td>
<td style="text-align: right;">1962.056</td>
<td style="text-align: right;">2231.404</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta[1,3]</td>
<td style="text-align: right;">0.7696227</td>
<td style="text-align: right;">0.7674775</td>
<td style="text-align: right;">0.1281324</td>
<td style="text-align: right;">0.1281975</td>
<td style="text-align: right;">0.5616610</td>
<td style="text-align: right;">0.9850567</td>
<td style="text-align: right;">1.001082</td>
<td style="text-align: right;">1935.714</td>
<td style="text-align: right;">2491.877</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[2,3]</td>
<td style="text-align: right;">0.1847624</td>
<td style="text-align: right;">0.1847795</td>
<td style="text-align: right;">0.0621539</td>
<td style="text-align: right;">0.0617154</td>
<td style="text-align: right;">0.0829161</td>
<td style="text-align: right;">0.2856263</td>
<td style="text-align: right;">1.001585</td>
<td style="text-align: right;">2039.268</td>
<td style="text-align: right;">2344.241</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta[1,4]</td>
<td style="text-align: right;">-0.0159379</td>
<td style="text-align: right;">-0.0157428</td>
<td style="text-align: right;">0.0161485</td>
<td style="text-align: right;">0.0161589</td>
<td style="text-align: right;">-0.0425290</td>
<td style="text-align: right;">0.0106129</td>
<td style="text-align: right;">1.000824</td>
<td style="text-align: right;">1903.619</td>
<td style="text-align: right;">2486.081</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[2,4]</td>
<td style="text-align: right;">-0.0097694</td>
<td style="text-align: right;">-0.0099567</td>
<td style="text-align: right;">0.0072523</td>
<td style="text-align: right;">0.0071187</td>
<td style="text-align: right;">-0.0214356</td>
<td style="text-align: right;">0.0025633</td>
<td style="text-align: right;">1.001157</td>
<td style="text-align: right;">1955.521</td>
<td style="text-align: right;">2089.158</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta[1,5]</td>
<td style="text-align: right;">-1.6925855</td>
<td style="text-align: right;">-1.6960200</td>
<td style="text-align: right;">0.2988801</td>
<td style="text-align: right;">0.3029248</td>
<td style="text-align: right;">-2.1781565</td>
<td style="text-align: right;">-1.2127295</td>
<td style="text-align: right;">1.000928</td>
<td style="text-align: right;">2014.424</td>
<td style="text-align: right;">2307.255</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[2,5]</td>
<td style="text-align: right;">-1.1352687</td>
<td style="text-align: right;">-1.1372500</td>
<td style="text-align: right;">0.1354035</td>
<td style="text-align: right;">0.1345978</td>
<td style="text-align: right;">-1.3593740</td>
<td style="text-align: right;">-0.9131014</td>
<td style="text-align: right;">1.001261</td>
<td style="text-align: right;">1660.067</td>
<td style="text-align: right;">1900.028</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-60_5c33b011219fbbbfafab7e9b5850d9c6">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(model_Multinomial<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"beta"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-60-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-61_a8f67ede4122eea820df80c3bce0a42a">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(model_Multinomial<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"beta"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-61-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>La predicción del número de persona en cada estado se obtiene como:</p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-62_c2f2d817ee03715aa5d086e3256e6091">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>ydat2 <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(ydat)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>y_pred_B <span class="ot">&lt;-</span> model_Multinomial<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="st">"ypred"</span>, <span class="at">format =</span> <span class="st">"matrix"</span>)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>rowsrandom <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(y_pred_B), <span class="dv">100</span>)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>y_pred2 <span class="ot">&lt;-</span> y_pred_B[rowsrandom, ]</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ppc_dens_overlay</span>(<span class="at">y =</span> ydat2, </span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>                 y_pred2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-62-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Para la probabilidad de pertenecer al estado <span class="math inline">\(k-esimo\)</span> se obtiene como:</p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-63_c88c422eded46315530d3ccbceeb453f">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>ydat2 <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(ydat<span class="sc">/</span><span class="fu">rowSums</span>(ydat))</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>y_pred_B <span class="ot">&lt;-</span> model_Multinomial<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="st">"theta"</span>, <span class="at">format =</span> <span class="st">"matrix"</span>)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>rowsrandom <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(y_pred_B), <span class="dv">100</span>)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>y_pred2 <span class="ot">&lt;-</span> y_pred_B[rowsrandom, ]</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ppc_dens_overlay</span>(<span class="at">y =</span> ydat2, </span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>                 y_pred2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-63-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
</section>
<section id="modelos-lineales-mixtos-y-multinivel" class="level1">
<h1>Modelos lineales mixtos y multinivel</h1>
<p>Aunque es posible proponer modelos que contemplen demasiadas etapas, no es realista ajustar modelos con más de tres niveles. Una formulación general para un modelo con dos niveles es la siguiente</p>
<p><span class="math display">\[
\begin{align*}
\mathbf{Y} \mid \mathbf{X}_1,\boldsymbol{\beta}_1,\boldsymbol{\Sigma}_{\mathbf{Y}}
&amp;\sim N_n(\mathbf{X}_1\boldsymbol{\beta}_1,\boldsymbol{\Sigma}_{\mathbf{Y}} )\\
\boldsymbol{\beta}_1 \mid \mathbf{X}_2,\boldsymbol{\beta}_2,\boldsymbol{\Sigma}_{\boldsymbol{\beta}_1}
&amp;\sim N_q(\mathbf{X}_2\boldsymbol{\beta}_2,\boldsymbol{\Sigma}_{\boldsymbol{\beta}_1})\\
\boldsymbol{\beta}_2 \mid \mathbf{b},\mathbf{B}&amp;\sim N_r(\mathbf{b},\mathbf{B})
\end{align*}
\]</span></p>
<p>donde <span class="math inline">\(\mathbf{b},\mathbf{B}\)</span> son hiperparámetros conocidos. Nótese que el orden de la verosimilitud de las observaciones es <span class="math inline">\(n\)</span>, el tamaño de la muestra, mientras que el orden de la distribución previa para el parámetro <span class="math inline">\(\boldsymbol{\beta}_1\)</span> es <span class="math inline">\(q\)</span>, el número de variables de información auxiliar para el primer nivel, y por último el orden de la distribución previa para el hiperparámetro <span class="math inline">\(\boldsymbol{\beta}_2\)</span> es <span class="math inline">\(r\)</span>, el número de variables de información auxiliar para el segundo nivel.</p>
<section id="intercepto-aleatorio" class="level2">
<h2 class="anchored" data-anchor-id="intercepto-aleatorio">Intercepto aleatorio</h2>
<p>Suponga que tenemos una población con estructura multinivel en el intercepto dado por la siguiente expresión:</p>
<p><span class="math display">\[
\begin{align*}
y_{ij} &amp;= \alpha_j + \beta X_{ij} + \epsilon_{ij}\\
\alpha_j &amp;= \gamma_0 + \gamma_1 U_{j}+e_{j}
\end{align*}
\]</span></p>
<p>donde <span class="math inline">\(Var(\epsilon_{ij})=\sigma^2_y\)</span> y <span class="math inline">\(Var(e_{j})=\sigma^2_{\alpha}\)</span> para <span class="math inline">\(i=1,\ldots,n_j\)</span> y <span class="math inline">\(j=1,\ldots,J\)</span>, <span class="math inline">\(X_{ij}\)</span> es una característica de información auxiliar a nivel del individuo y <span class="math inline">\(U_j\)</span> es una característica de información auxiliar a nivel de bloque o estructura conteniendo al individuo.</p>
<p>El anterior planteamiento también se puede escribir como:</p>
<p><span class="math display">\[
\begin{align*}
y_{ij} &amp;\sim N(\alpha_j + \beta X_{ij}, \sigma^2_y )\\
\alpha_j &amp;\sim N(\gamma_0 + \gamma_1 U_{j}, \sigma^2_{\alpha})
\end{align*}
\]</span> Para hallar la forma de estimar los coeficientes <span class="math inline">\(\beta\)</span>, <span class="math inline">\(\gamma_0\)</span> y <span class="math inline">\(\gamma_1\)</span>, Nótese que <span class="math inline">\(y_{ij} = \gamma_0 + \gamma_1 U_{j} + \beta X_{ij} + \epsilon_{ij}+e_{j}\)</span>, que a la vez es equivalente a</p>
<p><span class="math display">\[
\begin{align*}
y^{(1)}_{ij} &amp;= \beta X_{ij} + v_{ij}\\
y^{(2)}_{ij} &amp;= \gamma_0 + \gamma_1 U_{j} + v_{ij}
\end{align*}
\]</span></p>
<p>donde <span class="math inline">\(y^{(1)}_{ij}=y_{ij} - \gamma_0 - \gamma_1 U_{j}\)</span>, <span class="math inline">\(y^{(2)}_{ij}=y_{ij}-\beta X_{ij}\)</span> y <span class="math inline">\(v_{ij}=\epsilon_{ij}+e_{j}\)</span>. Las distribuciones previas de <span class="math inline">\(\beta\)</span> y <span class="math inline">\(\boldsymbol{\gamma}=(\gamma_0,\gamma_1)'\)</span> por <span class="math inline">\(\beta\sim N(\mu,\tau^2)\)</span> y <span class="math inline">\(\boldsymbol{\gamma}\sim N(\boldsymbol{\gamma}_0,\boldsymbol{\Gamma}_0)\)</span>, se tiene las siguientes distribuciones condicionales de <span class="math inline">\(\beta\)</span> y <span class="math inline">\(\boldsymbol{\gamma}\)</span></p>
<p><span class="math display">\[
\begin{align*}
\beta\mid \boldsymbol{\gamma}, \mathbf{y},\mathbf{X},\mathbf{U}&amp;\sim N(\mu_n,\tau^2_n)\\
\boldsymbol{\gamma}\mid \beta,\mathbf{y},\mathbf{X},\mathbf{U}&amp;\sim N(\boldsymbol{\gamma}_n,\boldsymbol{\Gamma}_n)
\end{align*}
\]</span></p>
<p>con <span class="math inline">\(\tau^2_n=(1/\tau^2+\sum_{i}x_i^2/(\sigma^2_y+\sigma^2_\alpha))^{-1}\)</span>, <span class="math inline">\(\mu_n=\tau^2_n(\mu/\tau^2+\sum x_{ij}y_{ij}^{(1)}/(\sigma^2_y+\sigma^2_\alpha))\)</span>, <span class="math inline">\(\boldsymbol{\Gamma}_n=(\boldsymbol{\Gamma}_0^{-1}+\mathbf{U}'\boldsymbol{\Sigma}_v^{-1}\mathbf{U})^{-1}\)</span> y <span class="math inline">\(\boldsymbol{\gamma}_n=\boldsymbol{\Gamma}_n(\boldsymbol{\Gamma}_0^{-1}\boldsymbol{\gamma}_0+\mathbf{U}'\boldsymbol{\Sigma}_v^{-1}\mathbf{y}^{(2)})\)</span>. <span class="math inline">\(\mathbf{U}\)</span> es la matriz de dimensión <span class="math inline">\(n\times 2\)</span> que contiene la columna de unos y los datos de <span class="math inline">\(U_j\)</span>, <span class="math inline">\(\mathbf{y}^{(2)}\)</span> es el vector que contiene los datos de <span class="math inline">\(y_{ij}^{(2)}\)</span> y <span class="math inline">\(\boldsymbol{\Sigma}_v=(\sigma^2_y+\sigma^2_\alpha)\mathbf{I}_n\)</span>.</p>
<section id="práctica-en-stan-3" class="level3">
<h3 class="anchored" data-anchor-id="práctica-en-stan-3">Práctica en <code>STAN</code></h3>
<p>Datos de la encuesta</p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-64_4d4f6dc90cdb06e9ae7b6f85b2935ab1">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>dataMultinivel <span class="ot">&lt;-</span> encuesta <span class="sc">%&gt;%</span> </span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">depto =</span> <span class="fu">str_pad</span>(</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">string =</span> dpto,</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">pad =</span> <span class="st">"0"</span>,</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">width =</span> <span class="dv">2</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">area =</span> <span class="fu">as_factor</span>(areageo2), </span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">ingreso =</span> ingcorte<span class="sc">+</span><span class="dv">1</span>,</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>   <span class="at">sexo =</span> <span class="fu">as_factor</span>(sexo),  </span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">anoest =</span> <span class="fu">case_when</span>(</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    edad <span class="sc">&lt;</span> <span class="dv">5</span> <span class="sc">|</span> anoest <span class="sc">==</span> <span class="sc">-</span><span class="dv">1</span>   <span class="sc">~</span> <span class="st">"98"</span>  ,    <span class="co">#No aplica</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>    anoest <span class="sc">&lt;</span> <span class="dv">1</span>  <span class="sc">~</span> <span class="st">"1"</span>,     <span class="co"># Sin educacion</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>    anoest <span class="sc">&lt;=</span> <span class="dv">6</span> <span class="sc">~</span> <span class="st">"2"</span>,   <span class="co"># 1 - 6</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>    anoest <span class="sc">&lt;=</span> <span class="dv">12</span> <span class="sc">~</span> <span class="st">"3"</span>,     <span class="co"># 7 - 12</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>    anoest <span class="sc">&gt;</span> <span class="dv">12</span> <span class="sc">~</span> <span class="st">"4"</span>,    <span class="co"># mas de 12</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>    anoest <span class="sc">==</span> <span class="dv">99</span> <span class="sc">~</span> <span class="st">"99"</span>,     <span class="co">#NS/NR ##### valida con cuidado</span></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Error"</span></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">edad =</span> <span class="fu">case_when</span>(</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>    edad <span class="sc">&lt;</span> <span class="dv">15</span> <span class="sc">~</span> <span class="st">"1"</span>,</span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>    edad <span class="sc">&lt;</span> <span class="dv">30</span> <span class="sc">~</span> <span class="st">"2"</span>,</span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>    edad <span class="sc">&lt;</span> <span class="dv">45</span> <span class="sc">~</span> <span class="st">"3"</span>,</span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>    edad <span class="sc">&lt;</span> <span class="dv">65</span> <span class="sc">~</span> <span class="st">"4"</span>,</span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"5"</span>),</span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(depto, area, anoest, edad, sexo) <span class="sc">%&gt;%</span> </span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a><span class="fu">summarise</span>(<span class="at">prom_Ingreso =</span> <span class="fu">mean</span>(ingreso), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a>dataMultinivel <span class="ot">&lt;-</span> dataMultinivel <span class="sc">%&gt;%</span> </span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tasa_desocupacion, <span class="at">by =</span> <span class="st">"depto"</span>)</span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dataMultinivel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 5%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 4%">
<col style="width: 6%">
<col style="width: 12%">
<col style="width: 17%">
<col style="width: 14%">
<col style="width: 13%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">depto</th>
<th style="text-align: left;">area</th>
<th style="text-align: left;">anoest</th>
<th style="text-align: left;">edad</th>
<th style="text-align: left;">sexo</th>
<th style="text-align: right;">prom_Ingreso</th>
<th style="text-align: right;">tasa_desocupacion</th>
<th style="text-align: right;">Luces_nocturna</th>
<th style="text-align: right;">Suelo_cultivo</th>
<th style="text-align: right;">Suelo_urbano</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">01</td>
<td style="text-align: left;">Urbano</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">Hombre</td>
<td style="text-align: right;">32721.84</td>
<td style="text-align: right;">0.0666792</td>
<td style="text-align: right;">29595.1</td>
<td style="text-align: right;">6008.267</td>
<td style="text-align: right;">27716.57</td>
</tr>
<tr class="even">
<td style="text-align: left;">01</td>
<td style="text-align: left;">Urbano</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">Mujer</td>
<td style="text-align: right;">26257.48</td>
<td style="text-align: right;">0.0666792</td>
<td style="text-align: right;">29595.1</td>
<td style="text-align: right;">6008.267</td>
<td style="text-align: right;">27716.57</td>
</tr>
<tr class="odd">
<td style="text-align: left;">01</td>
<td style="text-align: left;">Urbano</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">Hombre</td>
<td style="text-align: right;">33039.37</td>
<td style="text-align: right;">0.0666792</td>
<td style="text-align: right;">29595.1</td>
<td style="text-align: right;">6008.267</td>
<td style="text-align: right;">27716.57</td>
</tr>
<tr class="even">
<td style="text-align: left;">01</td>
<td style="text-align: left;">Urbano</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">Mujer</td>
<td style="text-align: right;">29742.83</td>
<td style="text-align: right;">0.0666792</td>
<td style="text-align: right;">29595.1</td>
<td style="text-align: right;">6008.267</td>
<td style="text-align: right;">27716.57</td>
</tr>
<tr class="odd">
<td style="text-align: left;">01</td>
<td style="text-align: left;">Urbano</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">4</td>
<td style="text-align: left;">Hombre</td>
<td style="text-align: right;">35893.41</td>
<td style="text-align: right;">0.0666792</td>
<td style="text-align: right;">29595.1</td>
<td style="text-align: right;">6008.267</td>
<td style="text-align: right;">27716.57</td>
</tr>
<tr class="even">
<td style="text-align: left;">01</td>
<td style="text-align: left;">Urbano</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">4</td>
<td style="text-align: left;">Mujer</td>
<td style="text-align: right;">38629.93</td>
<td style="text-align: right;">0.0666792</td>
<td style="text-align: right;">29595.1</td>
<td style="text-align: right;">6008.267</td>
<td style="text-align: right;">27716.57</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Ahora, podemos escribir el modelo en <code>STAN</code> empleando el</p>
<p><span class="math display">\[y_{ij} = \gamma_0 + \gamma_1 U_{j} + \beta X_{ij} + \epsilon_{ij}+e_{j}\]</span></p>
<p>Creando código de <code>STAN</code></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-65_cbfb1db85d54ca1c75d3d67487332889">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>data {</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  int <span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">0</span><span class="sc">&gt;</span>N;                      <span class="sc">/</span><span class="er">/</span> Número de observaciones</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  int <span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">0</span><span class="sc">&gt;</span>k;                      <span class="sc">/</span><span class="er">/</span> Número de covariables </span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  vector[N] y;                           <span class="sc">/</span><span class="er">/</span> Variables respuesta</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  matrix [N,k] X;                        <span class="sc">/</span><span class="er">/</span> Variables regresoras</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="sc">/</span><span class="er">/</span> efecto aleatorio </span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>  int <span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">0</span><span class="sc">&gt;</span>kz; </span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  matrix [N,kz] Z;                       <span class="sc">/</span><span class="er">/</span> Variables regresoras</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>parameters {</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>  vector[k] beta;                        <span class="sc">/</span><span class="er">/</span> coeficientes del modelo</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>  vector[kz] u;                          <span class="sc">/</span><span class="er">/</span> coeficientes del modelo</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>  real <span class="sc">&lt;</span>lower <span class="ot">=</span> <span class="dv">0</span><span class="sc">&gt;</span> sigma2;</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>transformed parameters{</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a> vector[N] mu;</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a> real<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> sigma;</span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a> sigma <span class="ot">=</span> <span class="fu">sqrt</span>(sigma2);</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a> mu <span class="ot">=</span>  X<span class="sc">*</span>beta <span class="sc">+</span> Z <span class="sc">*</span> u;</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>model {</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>  beta <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1000</span>);</span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>  u <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1000</span>);</span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>  sigma2 <span class="sc">~</span> <span class="fu">inv_gamma</span>(<span class="fl">0.0001</span>, <span class="fl">0.0001</span>);</span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="fu">normal</span>(mu , sigma);</span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a>generated quantities {</span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>    real ypred[N];                    <span class="sc">/</span><span class="er">/</span> vector de longitud N</span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a>    ypred <span class="ot">=</span>  <span class="fu">normal_rng</span>(mu , sigma);</span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Preparando el código de <code>STAN</code></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-66_5b369d3a380099caa8e6e1d1d4f29f08">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>fitMultinivel2 <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="at">stan_file =</span> <span class="st">"../Data/modelosStan/Multinivel_Intercepto2.stan"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Organizando datos para <code>STAN</code>.</p>
<p>Los efectos fijos los incluimos con <span class="math inline">\(X\)</span>:</p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-67_4170bb9a269e857cb594aa65abd6d922">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>Xdat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(prom_Ingreso <span class="sc">~</span> sexo <span class="sc">+</span> anoest <span class="sc">+</span> edad <span class="sc">+</span> tasa_desocupacion <span class="sc">+</span> Luces_nocturna <span class="sc">+</span> Suelo_cultivo <span class="sc">+</span> Suelo_urbano,</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> dataMultinivel)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Xdat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 9%">
<col style="width: 8%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 14%">
<col style="width: 12%">
<col style="width: 11%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">(Intercept)</th>
<th style="text-align: right;">sexoMujer</th>
<th style="text-align: right;">anoest2</th>
<th style="text-align: right;">anoest3</th>
<th style="text-align: right;">anoest4</th>
<th style="text-align: right;">edad3</th>
<th style="text-align: right;">edad4</th>
<th style="text-align: right;">edad5</th>
<th style="text-align: right;">tasa_desocupacion</th>
<th style="text-align: right;">Luces_nocturna</th>
<th style="text-align: right;">Suelo_cultivo</th>
<th style="text-align: right;">Suelo_urbano</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0666792</td>
<td style="text-align: right;">29595.1</td>
<td style="text-align: right;">6008.267</td>
<td style="text-align: right;">27716.57</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0666792</td>
<td style="text-align: right;">29595.1</td>
<td style="text-align: right;">6008.267</td>
<td style="text-align: right;">27716.57</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0666792</td>
<td style="text-align: right;">29595.1</td>
<td style="text-align: right;">6008.267</td>
<td style="text-align: right;">27716.57</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0666792</td>
<td style="text-align: right;">29595.1</td>
<td style="text-align: right;">6008.267</td>
<td style="text-align: right;">27716.57</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0666792</td>
<td style="text-align: right;">29595.1</td>
<td style="text-align: right;">6008.267</td>
<td style="text-align: right;">27716.57</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0666792</td>
<td style="text-align: right;">29595.1</td>
<td style="text-align: right;">6008.267</td>
<td style="text-align: right;">27716.57</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Los efectos aleatorios los incluimos en <span class="math inline">\(Z\)</span> así</p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-68_514196e5db792c14ac8b3d42793d0711">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>Zdat <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(prom_Ingreso <span class="sc">~</span> depto,</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> dataMultinivel)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Zdat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 7%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">(Intercept)</th>
<th style="text-align: right;">depto02</th>
<th style="text-align: right;">depto03</th>
<th style="text-align: right;">depto04</th>
<th style="text-align: right;">depto05</th>
<th style="text-align: right;">depto06</th>
<th style="text-align: right;">depto07</th>
<th style="text-align: right;">depto08</th>
<th style="text-align: right;">depto09</th>
<th style="text-align: right;">depto10</th>
<th style="text-align: right;">depto11</th>
<th style="text-align: right;">depto12</th>
<th style="text-align: right;">depto13</th>
<th style="text-align: right;">depto14</th>
<th style="text-align: right;">depto15</th>
<th style="text-align: right;">depto16</th>
<th style="text-align: right;">depto17</th>
<th style="text-align: right;">depto18</th>
<th style="text-align: right;">depto19</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-69_91ebd0f4c9f551840bd07dc8eaa1aad5">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>sample_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(dataMultinivel),</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">k =</span> <span class="fu">ncol</span>(Xdat),</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">X =</span> <span class="fu">as.matrix</span>(Xdat),</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">y =</span> dataMultinivel<span class="sc">$</span>prom_Ingreso,</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">kz =</span> <span class="fu">ncol</span>(Zdat),</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Z =</span> <span class="fu">as.matrix</span>(Zdat) </span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>                    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para ejecutar <code>STAN</code> en R tenemos la librería <em>cmdstanr</em></p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-70_1abc4bfa0586b8b3ad52de7fc23d065a">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>model_Multinivel2 <span class="ot">&lt;-</span> fitMultinivel2<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> sample_data,</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">num_warmup =</span> <span class="dv">4000</span>, </span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">num_samples =</span> <span class="dv">1000</span>,</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">parallel_chains =</span> <span class="dv">4</span>,</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">seed =</span> <span class="dv">1234</span>,</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">refresh =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 finished in 40.7 seconds.
Chain 2 finished in 41.9 seconds.
Chain 3 finished in 44.2 seconds.
Chain 4 finished in 54.2 seconds.

All 4 chains finished successfully.
Mean chain execution time: 45.3 seconds.
Total execution time: 54.5 seconds.</code></pre>
</div>
</div>
<p>La estimación de los parámetros:</p>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-71_4a7b8941988d566d8f297f9dfb1cbddd">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>model_Multinivel2<span class="sc">$</span><span class="fu">summary</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"beta"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(variable, mean, sd, q5,q95) <span class="sc">%&gt;%</span> </span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.numeric, round, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">beta[1]</td>
<td style="text-align: right;">4757.951</td>
<td style="text-align: right;">865.223</td>
<td style="text-align: right;">3327.268</td>
<td style="text-align: right;">6188.065</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[2]</td>
<td style="text-align: right;">-1011.359</td>
<td style="text-align: right;">598.936</td>
<td style="text-align: right;">-1998.459</td>
<td style="text-align: right;">-4.317</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta[3]</td>
<td style="text-align: right;">-3356.605</td>
<td style="text-align: right;">675.900</td>
<td style="text-align: right;">-4461.036</td>
<td style="text-align: right;">-2260.877</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[4]</td>
<td style="text-align: right;">482.623</td>
<td style="text-align: right;">670.953</td>
<td style="text-align: right;">-618.252</td>
<td style="text-align: right;">1586.448</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta[5]</td>
<td style="text-align: right;">11045.480</td>
<td style="text-align: right;">721.350</td>
<td style="text-align: right;">9836.093</td>
<td style="text-align: right;">12210.880</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[6]</td>
<td style="text-align: right;">-93.056</td>
<td style="text-align: right;">661.053</td>
<td style="text-align: right;">-1174.324</td>
<td style="text-align: right;">1004.724</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta[7]</td>
<td style="text-align: right;">4070.813</td>
<td style="text-align: right;">688.845</td>
<td style="text-align: right;">2924.688</td>
<td style="text-align: right;">5190.852</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[8]</td>
<td style="text-align: right;">6625.561</td>
<td style="text-align: right;">693.948</td>
<td style="text-align: right;">5487.316</td>
<td style="text-align: right;">7798.959</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta[9]</td>
<td style="text-align: right;">253.699</td>
<td style="text-align: right;">1027.944</td>
<td style="text-align: right;">-1417.064</td>
<td style="text-align: right;">1949.962</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[10]</td>
<td style="text-align: right;">-0.282</td>
<td style="text-align: right;">0.068</td>
<td style="text-align: right;">-0.394</td>
<td style="text-align: right;">-0.171</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta[11]</td>
<td style="text-align: right;">0.028</td>
<td style="text-align: right;">0.003</td>
<td style="text-align: right;">0.023</td>
<td style="text-align: right;">0.033</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[12]</td>
<td style="text-align: right;">1.123</td>
<td style="text-align: right;">0.139</td>
<td style="text-align: right;">0.893</td>
<td style="text-align: right;">1.353</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-72_b28e314cffcea88e80f5c10df1c036b6">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>model_Multinivel2<span class="sc">$</span><span class="fu">summary</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"u"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(variable, mean, sd, q5,q95) <span class="sc">%&gt;%</span> </span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.numeric, round, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">u[1]</td>
<td style="text-align: right;">4743.765</td>
<td style="text-align: right;">849.638</td>
<td style="text-align: right;">3336.326</td>
<td style="text-align: right;">6154.479</td>
</tr>
<tr class="even">
<td style="text-align: left;">u[2]</td>
<td style="text-align: right;">1822.128</td>
<td style="text-align: right;">845.947</td>
<td style="text-align: right;">428.831</td>
<td style="text-align: right;">3201.622</td>
</tr>
<tr class="odd">
<td style="text-align: left;">u[3]</td>
<td style="text-align: right;">-865.351</td>
<td style="text-align: right;">923.984</td>
<td style="text-align: right;">-2379.506</td>
<td style="text-align: right;">634.710</td>
</tr>
<tr class="even">
<td style="text-align: left;">u[4]</td>
<td style="text-align: right;">-914.454</td>
<td style="text-align: right;">844.314</td>
<td style="text-align: right;">-2313.934</td>
<td style="text-align: right;">449.580</td>
</tr>
<tr class="odd">
<td style="text-align: left;">u[5]</td>
<td style="text-align: right;">-1436.884</td>
<td style="text-align: right;">854.882</td>
<td style="text-align: right;">-2818.094</td>
<td style="text-align: right;">-29.131</td>
</tr>
<tr class="even">
<td style="text-align: left;">u[6]</td>
<td style="text-align: right;">759.079</td>
<td style="text-align: right;">865.947</td>
<td style="text-align: right;">-676.909</td>
<td style="text-align: right;">2184.146</td>
</tr>
<tr class="odd">
<td style="text-align: left;">u[7]</td>
<td style="text-align: right;">2142.317</td>
<td style="text-align: right;">877.676</td>
<td style="text-align: right;">687.511</td>
<td style="text-align: right;">3591.937</td>
</tr>
<tr class="even">
<td style="text-align: left;">u[8]</td>
<td style="text-align: right;">297.623</td>
<td style="text-align: right;">884.539</td>
<td style="text-align: right;">-1166.535</td>
<td style="text-align: right;">1732.676</td>
</tr>
<tr class="odd">
<td style="text-align: left;">u[9]</td>
<td style="text-align: right;">474.017</td>
<td style="text-align: right;">850.432</td>
<td style="text-align: right;">-926.086</td>
<td style="text-align: right;">1882.774</td>
</tr>
<tr class="even">
<td style="text-align: left;">u[10]</td>
<td style="text-align: right;">1534.663</td>
<td style="text-align: right;">860.914</td>
<td style="text-align: right;">121.770</td>
<td style="text-align: right;">2952.251</td>
</tr>
<tr class="odd">
<td style="text-align: left;">u[11]</td>
<td style="text-align: right;">-152.469</td>
<td style="text-align: right;">849.658</td>
<td style="text-align: right;">-1529.797</td>
<td style="text-align: right;">1271.042</td>
</tr>
<tr class="even">
<td style="text-align: left;">u[12]</td>
<td style="text-align: right;">107.164</td>
<td style="text-align: right;">876.742</td>
<td style="text-align: right;">-1311.208</td>
<td style="text-align: right;">1526.507</td>
</tr>
<tr class="odd">
<td style="text-align: left;">u[13]</td>
<td style="text-align: right;">827.542</td>
<td style="text-align: right;">860.676</td>
<td style="text-align: right;">-579.375</td>
<td style="text-align: right;">2278.199</td>
</tr>
<tr class="even">
<td style="text-align: left;">u[14]</td>
<td style="text-align: right;">411.379</td>
<td style="text-align: right;">841.227</td>
<td style="text-align: right;">-987.234</td>
<td style="text-align: right;">1800.289</td>
</tr>
<tr class="odd">
<td style="text-align: left;">u[15]</td>
<td style="text-align: right;">-1.719</td>
<td style="text-align: right;">850.938</td>
<td style="text-align: right;">-1399.342</td>
<td style="text-align: right;">1440.556</td>
</tr>
<tr class="even">
<td style="text-align: left;">u[16]</td>
<td style="text-align: right;">1224.930</td>
<td style="text-align: right;">858.635</td>
<td style="text-align: right;">-177.225</td>
<td style="text-align: right;">2633.619</td>
</tr>
<tr class="odd">
<td style="text-align: left;">u[17]</td>
<td style="text-align: right;">-1093.970</td>
<td style="text-align: right;">902.407</td>
<td style="text-align: right;">-2562.016</td>
<td style="text-align: right;">378.843</td>
</tr>
<tr class="even">
<td style="text-align: left;">u[18]</td>
<td style="text-align: right;">-262.454</td>
<td style="text-align: right;">884.589</td>
<td style="text-align: right;">-1724.603</td>
<td style="text-align: right;">1181.566</td>
</tr>
<tr class="odd">
<td style="text-align: left;">u[19]</td>
<td style="text-align: right;">-112.882</td>
<td style="text-align: right;">873.485</td>
<td style="text-align: right;">-1558.558</td>
<td style="text-align: right;">1323.723</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-73_68f6dda275518f6ccaaf0281d2484cc6">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>model_Multinivel2<span class="sc">$</span><span class="fu">summary</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"sigma"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(variable, mean, sd, q5,q95) <span class="sc">%&gt;%</span> </span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.numeric, round, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">11936.98</td>
<td style="text-align: right;">297.429</td>
<td style="text-align: right;">11462</td>
<td style="text-align: right;">12415.41</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-74_f799a3dbcc58b98bb93f345a1b3c1186">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(model_Multinivel2<span class="sc">$</span><span class="fu">draws</span>(</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span>   <span class="fu">c</span>(<span class="st">"beta[1]"</span>,<span class="st">"beta[2]"</span>,<span class="st">"beta[3]"</span>, <span class="st">"beta[4]"</span>, <span class="st">"beta[5]"</span>))) <span class="sc">+</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(model_Multinivel2<span class="sc">$</span><span class="fu">draws</span>(</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> <span class="fu">c</span>(<span class="st">"beta[6]"</span>,<span class="st">"beta[7]"</span>,<span class="st">"sigma"</span>))) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-74-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-75_30feb27baacaafafb9e91cc9b0706c82">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(model_Multinivel2<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="st">"beta"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-75-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-76_c708c04267c4c37a8960d780dde5a05b">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(model_Multinivel2<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"u"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-76-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="2Modelos-Lineal-y-Mixto_cache/html/unnamed-chunk-77_9b2c620c555c489e9ddc85d146a02bed">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>y_pred_B <span class="ot">&lt;-</span> model_Multinivel2<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="st">"ypred"</span>, <span class="at">format =</span> <span class="st">"matrix"</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>rowsrandom <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(y_pred_B), <span class="dv">100</span>)</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>y_pred2 <span class="ot">&lt;-</span> y_pred_B[rowsrandom, ]</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ppc_dens_overlay</span>(<span class="at">y =</span> dataMultinivel<span class="sc">$</span>prom_Ingreso, </span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>                 y_pred2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="2Modelos-Lineal-y-Mixto_files/figure-html/unnamed-chunk-77-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>